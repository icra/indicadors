<!doctype html><html><head>
  <title>ICRA indicadors</title>
  <meta charset="utf8">

  <!--lib vue-->
  <script src="lib/vue.global.prod.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"
    integrity="sha512-dlPw+ytv/6JyepmelABrgeYgHI0O+frEwgfnPdXDTOIZz+eDgfW07QXG02/O8COfivBdGNINy+Vex+lYmJ5rxw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>

  <style>
    body{
      font-family: Eczar, IM Fell English, Georgia, serif;
    }
    table{
      border-collapse:collapse;
    }
    td,th{
      padding:0;
    }
    summary:hover{
      cursor:pointer;
      text-decoration:underline;
    }
    label:hover{
      background:lightyellow;
    }
    [bold]{
      font-weight:bold;
    }
    [small]{
      font-size:smaller;
    }
    [xsmall]{
      font-size:x-small;
    }
    [large]{
      font-size:larger;
    }
    [center]{
      text-align:center;
    }
    [right]{
      text-align:right;
    }
    [monospace]{
      font-family:monospace;
    }
    [nom_bloc]{
      color:darkblue;
      cursor:pointer;
    }
    [nom_bloc]:hover{
      text-decoration:underline;
    }
    [nowrap]{
      white-space:nowrap;
    }
    #caption{
      position:fixed;
      z-index:999;
      background:white;
      padding:0.3em 0.5em;
      box-shadow: 1px 1px 1px 1px rgba(0,0,0,.1);
      border:1px solid #ccc;
      color:#666;
      text-align:left;
      max-width:800px;
    }
    [vista_detalls_indicador]{
      border:1px solid #ccc;
      background:lightyellow;
      box-shadow:1px 1px 10px #ccc;
      padding:5px;
    }
    button[ambit_actual=true]{
      background:royalblue;
      color:white;
    }
  </style>
<head></head><body>
<b>en construcció</b><hr>

<!--nav--><div id=nav></div><hr><script src="nav.js"></script>

<h2>Indicadors de centre</h2><hr>

<div id=app>
  <!--finestra petita mòbil-->
  <div
    id=caption
    v-html="caption.text"
    v-show="caption.visible"
  ></div>

  <!--avís certificat-->
  <div v-if="!tot_carregat">
    Perquè tot funcioni cal:<ol>
      <li>
        Estar dins la xarxa de l'ICRA (o a la VPN)
      </li>
      <li>
        Descarregar i importar aquest certificat:
        <a href="https://undarius.icra.local:50000/server.cert">certificat HTTPS Undarius</a>
      </li>
    </ol><hr>
  </div>

  <!--pestanyes-->
  <div>
    <button
      v-for="ambit in ambits"
      @click="ambit_actual=ambit"
      :ambit_actual="ambit==ambit_actual"
    >
      {{ambit.nom}}
    </button>
  </div><hr>

  <!--finestra detalls indicador-->
  <div v-if="vista_detalls_indicador" vista_detalls_indicador>
    <div>
      <button
        @click="vista_detalls_indicador=false"
        title="Tancar finestra detalls"
        style="padding:0.618em 1em"
        v-html="'X'"
      />
    </div>
    <div v-html="html_detalls_indicador"></div>
  </div>

  <!--secció indicadors-->
  <details open>
    <summary large bold>
      Taula indicadors ({{ambit_actual.blocs.map(b=>b.indicadors.length).reduce((p,c)=>p+c,0)}})
    </summary>
    <p v-if="tot_carregat">
      Puntuació total: 0 (pendent implementar fórmula. Puntuació = pes_bloc*pes_indicador*increment/objectiu)
    </p>
    <p>
      <label>
        <input type=checkbox v-model="caption.actiu">
        Mostrar finestreta flotant detalls indicadors
      </label>
    </p>
    <table border=1>
      <tr>
        <td center><b>Pes</b></td>
        <td><b>Blocs</b></td>
        <th v-for="year in years" center>{{year}}</th>
        <td center>
          <button @click="calcular_tots_els_indicadors()" :disabled="!tot_carregat">calcular tots</button>
        </td>
      </tr>
      <tbody v-for="bloc,i in ambit_actual.blocs">
        <tr style="background:#eee">
          <td right><b>{{bloc.pes_percent}}%</b></td>
          <td>
            <b nom_bloc @click="bloc.visible^=1">
              <span>{{i+1}}. {{bloc.nom}}</span>
              <small> ({{bloc.indicadors.length}} ind.)</small>
            </b>
          </td>
          <td v-for="year in years" center monospace title="Puntuació" style="color:darkblue">
            <b v-if="false">{{bloc.puntuacio(year).toFixed(1)}}</b>
          </td>
          <td></td>
        </tr>
        <tr v-for="indi,j in bloc.indicadors" v-if="bloc.visible">
          <td small right>{{indi.pes_percent}}%</td>
          <td small>
            <div style="display:flex;justify-content:space-between">
              <div>{{i+1}}.{{j+1}}.
                <span :title="indi.text">{{indi.text.slice(0,100)}}</span>
                <span v-if="indi.text.length>100">...</span>
              </div>
              <div small style="color:#666" v-if="indi.unit">({{indi.unit}})</div>
            </div>
          </td>
          <td v-for="obj,year in indi.years" center small nowrap monospace>
            <div v-for="incr in [indi.increment(year)]"
              @mousemove="mousemove_indicador($event,indi,year)"
              @mouseout="caption.hide()"
            >
              <div>
                <!--valor cru indicador-->
                <span>{{obj.valor.toFixed(0)}}</span>

                <!--increment i objectiu-->
                <div v-if="!obj.excloure && obj.valor" small>
                  <span :style="{color:incr.compleix?'green':'red'}">
                    <span v-if="incr.delta>0">&uarr;</span>
                    <span v-if="incr.delta<0">&darr;</span>
                    <span>
                      {{Math.abs(incr.perc).toFixed(0)}}%
                    </span>
                  </span>
                  <!-- veure objectiu?
                  <span>
                    (&uarr;{{incr.objectiu}}%)
                  </span>
                  -->
                  <button @click="click_detalls_indicador(indi,year)" style="padding:0;font-size:x-small">detalls</button>
                </div>
              </div>
            </div>
          </td>
          <td center>
            <button
              v-if="funcions_calculadores[indi.funcio_calculadora]"
              @click="indi.calcula()"
              xsmall
              :disabled="!tot_carregat"
              style="display:block"
              >
              calcular indicador
            </button>
            <span v-else xsmall style="color:#bbb">pendent</span>
          </td>
        </tr>
      </tbody>
    </table>
  </details><hr>

  <!--indicador debug-->
  <p>Taules de desenvolupament (no seran visibles a la versió final)</p><hr>

  <!--bucle taules development-->
  <div v-for="taula in Object.keys(taules)">
    <details>
      <summary large bold>
        Taula {{taula}}
        <span v-if="taules[taula].taula" small>
          ({{taules[taula].files_filtrades.length}}/{{taules[taula].taula.length}} items)
        </span>
      </summary>

      <div v-if="!taules[taula].taula">carregant "{{taula}}" (SQL)...</div>
      <div v-if="!taules[taula].taula && !carregant">error consulta SQL Server ICRA</div>

      <!--checkboxes per veure columnes-->
      <p v-if="taules[taula].taula?.length" small>
        <label v-for="val,key in taules[taula].taula[0]">
          <input type=checkbox v-model="taules[taula].columnes[key]">
          <span :style="{color:taules[taula].filtres[key]!=undefined?'blue':''}">{{key}}</span>
        </label>
      </p>

      <table border=1 v-if="taules[taula].taula?.length" small>
        <tr>
          <th v-for="key in taules[taula].columnes_actives">
            <button @click="taules[taula].taula.sort((a,b)=>a[key]>b[key]?1:-1)">&darr;{{key}}</button>
            <button v-if="taules[taula].filtres[key]!=undefined" @click="delete taules[taula].filtres[key]">
              ="{{taules[taula].filtres[key].substring(0,50)}}"
            </button>
            <button @click="taules[taula].columnes[key]=false">X</button>
          </th>
        </tr>
        <tr v-for="row in taules[taula].files_filtrades">
          <td v-for="key in taules[taula].columnes_actives">
            <span @click="taules[taula].filtres[key]=row[key]">{{row[key]}}</span>
          </td>
        </tr>
      </table>
    </details><hr>
  </div>
</div>

<script>//classes i dades
  /*classe àmbit: conjunt de blocs*/
  class Ambit{
    constructor(nom, blocs){
      this.nom=nom||"nom àmbit";
      this.blocs=blocs||[]; //array objectes {Bloc}
    }
  }

  /*classe bloc: conjunt d'indicadors*/
  class Bloc{
    constructor(nom, pes_percent, indicadors){
      this.nom         = nom;
      this.pes_percent = pes_percent;
      this.indicadors  = indicadors||[]; //array objectes {Indicador}

      //GUI opcions
      this.visible=1;
    }

    //suma puntuació de tots els indicadors
    puntuacio(year){
      return this.indicadors.map(i=>i.puntuacio(year)).reduce((p,c)=>p+c,0);
    }
  }

  /*classe indicador: objecte principal*/
  class Indicador{
    constructor(id, pes_percent, objectius, valor_basal){
      objectius   = objectius   ||[]; //array percentatges
      valor_basal = valor_basal || 0;

      this.text        = textos[id];       //String
      this.unit        = unitats[id];      //String
      this.pes_percent = pes_percent || 0; //number

      if(!this.text) throw(`no text for ${id}`)

      this.base_year = "2023"; //String

      //funció que calcula l'indicador per un determinat any. Modifica this.years[year][valor i llista]
      this.funcio_calculadora = id; //String

      //Cada indicador té varis anys:
      //  valor: numero, valor cru de l'indicador en sí per aquell any
      //  llista: array des d'on es calcula el valor. El genera la funció calculadora
      //  objectiu: numero (percentatge que cal assolir)
      //  excloure: per l'any basal no mostrar indicadors
      this.years={
        "2023":{valor:valor_basal, llista:null, objectiu:0, excloure:true},
        "2024":{valor:0, llista:null, objectiu:objectius[0]||0},
        //"2025":{valor:0, llista:null, objectiu:objectius[1]||0},
        //"2026":{valor:0, llista:null, objectiu:objectius[2]||0},
        //"2027":{valor:0, llista:null, objectiu:objectius[3]||0},
        //"2028":{valor:0, llista:null, objectiu:objectius[4]||0},
        //"2029":{valor:0, llista:null, objectiu:objectius[5]||0},
      };
    }

    //calcula puntuació
    puntuacio(year){
      let pes = this.pes_percent/100;
      let val = this.years[year] ? this.years[year].valor : 0;
      let punts = pes*val;
      return punts;
    }

    increment(year){
      let base     = this.years[this.base_year].valor||0; //number valor base
      let curr     = this.years[String(year)].valor||0;   //number valor actual
      let delta    = curr - base;                         //number diferencia
      let perc     = 100*delta/base||0;                   //number diferencia (%)
      let objectiu = this.years[year].objectiu;           //number objectiu (%)
      let compleix = perc >= objectiu;                    //bool   compleix
      return {delta,perc,objectiu,compleix};
    }

    //calcula indicador a tots els anys
    calcula(){
      if(!app.tot_carregat){
        let msg="impossible calcular indicador";
        alert(msg);
        throw(msg);
        return 0;
      };
      let id = this.funcio_calculadora;
      if(!app.funcions_calculadores[id]){
        return false;
      }

      Object.entries(this.years)
        .filter(e=>!e[1].excloure).map(e=>e[0])
        .forEach(year=>{
          app.funcions_calculadores[id](year, this);
        });
    }
  }

  /*taules helper*/

  //taula: "id_indicador"=>"text indicador"
  let textos={
    "euros_recerca"                                         : `Aportació econòmica total a través de projectes o contractes de recerca`,
    "euros_recerca_horizon"                                 : `Aportació econòmica de projectes de recerca competitius Europeus (Horizon)`,
    "euros_recerca_erc_eic"                                 : `Aportació econòmica de projectes de recerca competitius Europeus (ERC-EIC)`,
    "euros_recerca_estatal"                                 : `Aportació econòmica de projectes de recerca competitius estatals (AEI-ERANETs)`,
    "euros_recerca_regional"                                : `Aportació econòmica de projectes de recerca competitius regionals (ACA-AGAUR)`,
    "projectes_horizon"                                     : `Projectes de recerca competitius vigents tipus Horizon coordinats`,
    "projectes_erc_eic"                                     : `Projectes de recerca competitius vigents tipus ERC o EIC`,
    "congressos_tallers_escoles_estiu_organitzats"          : `Congressos/tallers/escoles d'estiu i altres activitats internacionals de recerca organitzats per ICRA`,
    "sessions_especials_organitzades"                       : `Sessions especials en congressos organitzades per ICRA`,
    "comites_internacionals_participats"                    : `Comitès internacionals (i.e. SAB/panell d'avaluació/expert group...) participats per ICRA`,
    "articles_Q1"                                           : `Articles científics al Q1 (segons Scopus)`,
    "articles_Q1_amb_lideratge"                             : `Articles científics al Q1 (segons Scopus) amb lideratge ICRA (primer, darrer, o autor de correspondència)`,
    "articles_D1"                                           : `Articles científics al D1 (segons Scopus)`,
    "articles_FWCI_10"                                      : `Articles científics influents amb un factor d'impacte ponderat per cites (FWCI)>10 (segons Scopus)`,
    "cites_articles"                                        : `Cites anuals (segons Scopus)`,
    "impact_factor"                                         : `Índex d'impacte (Impact factor) de la institució (segons Scopus) en el moment de l'anàlisi`,
    "estades_recercaires_acollits"                          : `Estades de recercaires (predocs, postdocs, seniors) internacionals a ICRA`,
    "estades_recercaires_en_altres_centres"                 : `Estades de recercaires ICRA (predocs, postdocs, seniors) en centres internacionals`,
    "rati_exit_propostes_europa"                            : `Rati d'èxit de les propostes de recerca competitives Europees (Horizon, ERC, EIC)`,
    "euros_recerca_L17_L18"                                 : `Aportació econòmica total a través de projectes o contractes de recerca a les noves línies L17 i L18`,
    "articles_Q1_L17_L18"                                   : `Articles científics al Q1 (segons Scopus) associats a la L17 i la L18`,
    "euros_projectes_KTT_respecte_total"                    : `Percentatge d'aportacions de projectes/contractes de recerca tipus KTT respecte el total de les aportacions per recerca (competitius+KTT+mecenatge)`,
    "euros_projectes_KTT"                                   : `Aportació econòmica a través de projectes/contractes tipus KTT`,
    "projectes_KTT"                                         : `Projectes/contractes tipus KTT en curs`,
    "formacions_per_empreses_organitzades"                  : `Formacions/tallers per empreses/administracions organitzats per ICRA`,
    "projectes_llavor_producte_innovadors"                  : `Projectes en l'àmbit de la indústria de coneixement (Llavor, Producte, Innovadors, EIC, o equivalents)`,
    "doctorats_industrials"                                 : `Doctorats industrials en curs`,
    "euros_mecenatge"                                       : `Aportació econòmica a través de projectes de recerca per mecenatge`,
    "projectes_mecenatge"                                   : `Projectes de recerca per mecenatge`,
    "patents_i_secrets_industrials"                         : `Patents/secrets industrials en tramitació o vigents`,
    "spinoffs_i_startups"                                   : `Spin-offs o start-ups amb participació d'ICRA en curs`,
    "articles_amb_socis_industrials"                        : `Percentatge articles científics amb socis industrials (no acadèmics) com a co-autors`,
    "estudiants_acollits"                                   : `Estudiants d'ESO o Batxillerat acollits o mentoritzats des d'ICRA`,
    "cites_en_legislacio"                                   : `Cites en legislació (segons Sage Policy Profiles, sagepub.com)`,
    "participacions_comites_experts_ambit_legislatiu"       : `Participacions en comites d'experts en l'àmbit legislatiu i de gestió de l'aigua`,
    "premis_nacionals"                                      : `Premis/reconeixements a nivell regional/estatal`,
    "premis_internacionals"                                 : `Premis/reconeixements a nivell internacional`,
    "narratives_impacte_CERCA"                              : `Narratives d'impacte sotmeses a CERCA i avaluades amb un excel·lent o outstanding`,
    "contribucions_gestio_aigua"                            : `Contribucions a canvis en la gestió de l'aigua a les conques internes de Catalunya`,
    "llocs_de_treball_generats_llicencies"                  : `Llocs de treball generats mitjançant llicències amb participació d'ICRA`,
    "aliances_solides_entitats_socials"                     : `Aliances sòlides amb entitats que tinguin una finalitat social (ambientals, esportives, culturals, educatives)`,
    "xxss_seguidors"                                        : `Seguidors/subscriptors a les xarxes socials d'ICRA`,
    "xxss_shares"                                           : `Comparticions (shares, retweets) a les xarxes socials d'ICRA`,
    "xxss_plays"                                            : `Visualitzacions de sessions de streaming realitzades a les xarxes socials d'ICRA`,
    "actes_disseminacio_participats_o_organitzats"          : `Actes de disseminació participats o organitzats per ICRA`,
    "aparicions_mitjans_comunicacio_nacionals"              : `Aparicions en els mitjans de comunicació escrits i audiovisuals regionals o estatals`,
    "aparicions_mitjans_comunicacio_internacionals"         : `Aparicions en els mitjans de comunicació escrits i audiovisuals internacionals`,
    "reunions_taula_aigua_ACA"                              : `Reunions de la Taula de l'Aigua amb l'ACA`,
    "hores_tasques_taula_aigua_ACA"                         : `Hores computades per IPs a tasques associades a la taula de l'Aigua`,
    "euros_projectes_KTT_ACA"                               : `Aportacions de projectes o contractes de KTT amb l'ACA, via contracte programa o licitació`,
    "tallers_UdG_ICRA"                                      : `Organitzacions i participacions en tallers UdG-ICRA per enfortir col·laboració en marc de l'aigua`,
    "iniciatives_UdG_ICRA"                                  : `Iniciatives de recerca conjuntes UdG-ICRA`,
    "euros_projectes_KTT_UdG"                               : `Aportació econòmica de projectes o contractes de KTT conjuntament amb UdG`,
    "participacions_activitats_JEDI_organitzades_per_CERCA" : `Participació en actes/activitats organitzades per DREU/CERCA en l'àmbit de 'Dones i Ciència'/'Ciència a les escoles' o similars`,
    "eficiencia_articles_amb_socis_industrials"             : `Eficiència articles amb socis industrials o de l'administració pública respecte ingressos`,
    "objectius_assolits_del_pla_formacio"                   : `Objectius del pla de formació anual assolits`,
    "participants_actes_disseminacio_participats"           : `Participants en actes de disseminació participats per ICRA`,
    "projectes_competitius_outreach"                        : `Projectes singulars competitius per desenvolupar activitats d'outreach`,
    "euros_projectes_competitius_outreach"                  : `Aportació econòmica (k€ executats) en projectes competitius per activitats d'outreach`,
    "aliances_solides_empreses_i_administracio_publica"     : `Aliances sòlides amb empreses i administració pública`,
    "projectes_i_encarrecs_ACA"                             : `Projectes/encàrrecs directes de l'ACA`,
    "accions_suport_tecnic_a_ACA_quimica_analitica"         : `Accions de suport tècnic ofertes a l'ACA en temes de química analítica`,
    "participants_tallers_UdG_ICRA"                         : `Participants en tallers/seminaris UdG-ICRA`,
    "nombre_IPs"                                            : `Nombre d'IPs`,
    "posicions_RF_creades"                                  : `Posicions de Research Fellow creades`,
    "posicions_RS_estabilitzacio_RF"                        : `Noves posicions de Research Scientist per estabilització de Research Fellows`,
    "canvis_tram_RS_o_RP"                                   : `Canvis de tram dins d'una mateixa categoria de Research Scientist o Research Professor`,
    "sessions_JEDI_formacio_interna"                        : `Sessions de formació interna per personal ICRA per fomentar valors JEDI`,
    "participants_sessions_JEDI_formacio_interna"           : `Proporció del personal que participa les formacions del JEDI anualment`,
    "activitats_JEDI_organitzades"                          : `Organització d'activitats per fomentar valors JEDI en la recerca`,
    "dones_categories_laborals_superiors"                   : `Percentatge de dones en categories laborals superiors o amb càrrecs de gestió i lideratge (IPs i caps de departament)`,
    "projectes_amb_administracio_central"                   : `Projectes/contractes/comitès amb participació d'ICRA i de l'administració central de l'estat`,
    "euros_projectes_amb_administracio_central"             : `Aportació econòmica (k€ executats) en contractes de recerca amb l'administració central de l'estat`,
  };

  //taula: "id_indicador"=>"unitat indicador"
  let unitats={
    "euros_recerca"                                         : `k€`,
    "euros_recerca_horizon"                                 : `k€`,
    "euros_recerca_erc_eic"                                 : `k€`,
    "euros_recerca_estatal"                                 : `k€`,
    "euros_recerca_regional"                                : `k€`,
    "projectes_horizon"                                     : `projectes`,
    "projectes_erc_eic"                                     : `projectes`,
    "congressos_tallers_escoles_estiu_organitzats"          : `activitats`,
    "sessions_especials_organitzades"                       : `sessions`,
    "comites_internacionals_participats"                    : `comites`,
    "articles_Q1"                                           : `articles`,
    "articles_Q1_amb_lideratge"                             : `articles`,
    "articles_D1"                                           : `articles`,
    "articles_FWCI_10"                                      : `articles`,
    "cites_articles"                                        : `cites`,
    "impact_factor"                                         : `IF`,
    "estades_recercaires_acollits"                          : `estades`,
    "estades_recercaires_en_altres_centres"                 : `estades`,
    "rati_exit_propostes_europa"                            : `rati`,
    "euros_recerca_L17_L18"                                 : `k€`,
    "articles_Q1_L17_L18"                                   : `articles`,
    "euros_projectes_KTT_respecte_total"                    : `%`,
    "euros_projectes_KTT"                                   : `k€`,
    "projectes_KTT"                                         : `projectes`,
    "formacions_per_empreses_organitzades"                  : `formacions`,
    "projectes_llavor_producte_innovadors"                  : `projectes`,
    "doctorats_industrials"                                 : `persones`,
    "euros_mecenatge"                                       : `k€`,
    "projectes_mecenatge"                                   : `projectes`,
    "patents_i_secrets_industrials"                         : `#`,
    "spinoffs_i_startups"                                   : `#`,
    "articles_amb_socis_industrials"                        : `articles`,
    "estudiants_acollits"                                   : `persones`,
    "cites_en_legislacio"                                   : `cites`,
    "participacions_comites_experts_ambit_legislatiu"       : `persones`,
    "premis_nacionals"                                      : `premis`,
    "premis_internacionals"                                 : `premis`,
    "narratives_impacte_CERCA"                              : `narratives`,
    "contribucions_gestio_aigua"                            : `contribucions`,
    "llocs_de_treball_generats_llicencies"                  : `llocs de treball`,
    "aliances_solides_entitats_socials"                     : `aliances`,
    "xxss_seguidors"                                        : `seguidors`,
    "xxss_shares"                                           : `shares`,
    "xxss_plays"                                            : `views`,
    "actes_disseminacio_participats_o_organitzats"          : `actes`,
    "aparicions_mitjans_comunicacio_nacionals"              : `aparicions`,
    "aparicions_mitjans_comunicacio_internacionals"         : `aparicions`,
    "reunions_taula_aigua_ACA"                              : `reunions`,
    "hores_tasques_taula_aigua_ACA"                         : `hores`,
    "euros_projectes_KTT_ACA"                               : `k€`,
    "tallers_UdG_ICRA"                                      : `tallers`,
    "iniciatives_UdG_ICRA"                                  : `iniciatives`,
    "euros_projectes_KTT_UdG"                               : `k€`,
    "participacions_activitats_JEDI_organitzades_per_CERCA" : `actes`,
    "eficiencia_articles_amb_socis_industrials"             : `k€/article`,
    "objectius_assolits_del_pla_formacio"                   : `%`,
    "participants_actes_disseminacio_participats"           : `participants`,
    "projectes_competitius_outreach"                        : `projectes`,
    "euros_projectes_competitius_outreach"                  : `k€`,
    "aliances_solides_empreses_i_administracio_publica"     : `aliances`,
    "projectes_i_encarrecs_ACA"                             : `projectes`,
    "accions_suport_tecnic_a_ACA_quimica_analitica"         : `accions de suport tècnic`,
    "participants_tallers_UdG_ICRA"                         : `participants`,
    "nombre_IPs"                                            : `persones`,
    "posicions_RF_creades"                                  : `posicions`,
    "posicions_RS_estabilitzacio_RF"                        : `posicions`,
    "canvis_tram_RS_o_RP"                                   : `canvis`,
    "sessions_JEDI_formacio_interna"                        : `sessions`,
    "participants_sessions_JEDI_formacio_interna"           : `%`,
    "activitats_JEDI_organitzades"                          : `activitats`,
    "dones_categories_laborals_superiors"                   : `persones`,
    "projectes_amb_administracio_central"                   : `projectes`,
    "euros_projectes_amb_administracio_central"             : `k€`,
  };

  //taula: "id_indicador"=> function
  let funcions_calculadores={
    euros_recerca(year,indicador){
      //filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //filtra per "RECERCA"
      let projectes = app.taules.projectes.taula
        .filter(p=>p["Concurrencia"]=="FONS COMPETITIUS");

      //ajunta taules en un diccionari per codi projecte
      let joined={};

      ingressos.forEach(ing=>{
        let codi      = ing.Codi;      //codi projecte
        let ingressos = ing.Ingressos; //euros
        let projecte  = projectes.find(p=>p["Código Identificativo"]==codi);
        if(!projecte)   return;
        joined[codi]={
          projecte,
          ingressos,
        };
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).reduce((p,c)=>p+c,0)/1000; //number

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          ingressos: row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });
    },//OK

    euros_recerca_horizon(year,indicador){
      //filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //filtra projectes
      let projectes = app.taules.projectes.taula.filter(proj=>{
        return(
          proj["Concurrencia"]=="FONS COMPETITIUS"&&
          proj["Naturaleza del Proyecto"]=="EUROPEA"&&
          proj["Financiador Convocatoria"]!=null&&
          (
            proj["Financiador Convocatoria"].includes("H2020")||
            proj["Financiador Convocatoria"].includes("HORIZON")
          )
        );
      });

      //ajunta taules per codi projecte
      let joined={};
      projectes.forEach(projecte=>{
        let codi = projecte["Código Identificativo"]; //codi projecte
        let ing  = ingressos.find(i=>i.Codi==codi); //objecte
        if(!ing) return;
        joined[codi]={
          projecte,
          ingressos: ing.Ingressos,
        }
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).reduce((p,c)=>p+c,0)/1000; //number

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          ingressos: row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });

      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
    },//OK

    euros_recerca_erc_eic(year,indicador){
      //projectes ERC vigents a l'any "year"
      let projectes = app.taules.projectes.taula.filter(proj=>{
        return(
          proj["Concurrencia"]=="FONS COMPETITIUS"&&
          proj["Naturaleza del Proyecto"]=="EUROPEA"&&
          proj["Financiador Convocatoria"]!=null&&
          proj["Financiador Convocatoria"].includes("ERC")
        );
      });
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //ajunta taules per codi projecte
      let joined={};
      projectes.forEach(projecte=>{
        let codi = projecte["Código Identificativo"]; //codi projecte
        let ing  = ingressos.find(i=>i.Codi==codi); //objecte
        if(!ing) return;
        joined[codi]={
          projecte,
          ingressos: ing.Ingressos,
        }
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).reduce((p,c)=>p+c,0)/1000; //number

      app.taules.projectes.columnes["Financiador Convocatoria"]=true;

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          ingressos: row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });
    },//OK

    euros_recerca_estatal:null,
    euros_recerca_regional:null,

    projectes_horizon(year, indicador){
      //calcula nombre de projectes horizon vigents
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="FONS COMPETITIUS"&&
          pro["Naturaleza del Proyecto"]=="EUROPEA"&&
          pro["Financiador Convocatoria"]!=null&&
          (
            pro["Financiador Convocatoria"].includes("H2020")||
            pro["Financiador Convocatoria"].includes("HORIZON")
          )
        );
      });
      indicador.years[year].valor  = projectes.length;
      indicador.years[year].llista = projectes.map(row=>{
        let new_row={};
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key]=row[key];
        });
        return new_row;
      });

      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
    },//falta filtrar per data

    projectes_erc_eic(year, indicador){
      //calcula nombre de projectes horizon vigents
      let projectes = app.taules.projectes.taula.filter(proj=>{
        return(
          proj["Concurrencia"]=="FONS COMPETITIUS"&&
          proj["Naturaleza del Proyecto"]=="EUROPEA"&&
          proj["Financiador Convocatoria"]!=null&&
          proj["Financiador Convocatoria"].includes("ERC")
        );
      });
      indicador.years[year].valor  = projectes.length;
      indicador.years[year].llista = projectes.map(row=>{
        let new_row={};
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key]=row[key];
        });
        return new_row;
      });
    },//falta filtrar per data

    congressos_tallers_escoles_estiu_organitzats:null,
    sessions_especials_organitzades:null,
    comites_internacionals_participats:null,

    articles_Q1:null,

    articles_Q1_amb_lideratge:null,
    articles_D1:null,
    articles_FWCI_10:null,

    cites_articles:null,
    impact_factor:null,
    estades_recercaires_acollits:null,
    estades_recercaires_en_altres_centres:null,
    rati_exit_propostes_europa:null,
    euros_recerca_L17_L18:null,
    articles_Q1_L17_L18:null,
    euros_projectes_KTT_respecte_total:null,
    euros_projectes_KTT:null,
    projectes_KTT:null,
    formacions_per_empreses_organitzades:null,
    projectes_llavor_producte_innovadors:null,
    doctorats_industrials:null,
    euros_mecenatge:null,
    projectes_mecenatge:null,
    patents_i_secrets_industrials:null,
    spinoffs_i_startups:null,
    articles_amb_socis_industrials:null,
    estudiants_acollits:null,
    cites_en_legislacio:null,
    participacions_comites_experts_ambit_legislatiu:null,
    premis_nacionals:null,
    premis_internacionals:null,
    narratives_impacte_CERCA:null,
    contribucions_gestio_aigua:null,
    llocs_de_treball_generats_llicencies:null,
    aliances_solides_entitats_socials:null,
    xxss_seguidors:null,
    xxss_shares:null,
    xxss_plays:null,
    actes_disseminacio_participats_o_organitzats:null,
    aparicions_mitjans_comunicacio_nacionals:null,
    aparicions_mitjans_comunicacio_internacionals:null,
    reunions_taula_aigua_ACA:null,
    hores_tasques_taula_aigua_ACA:null,
    euros_projectes_KTT_ACA:null,
    tallers_UdG_ICRA:null,
    iniciatives_UdG_ICRA:null,
    euros_projectes_KTT_UdG:null,
    participacions_activitats_JEDI_organitzades_per_CERCA:null,
    eficiencia_articles_amb_socis_industrials:null,
    objectius_assolits_del_pla_formacio:null,
    participants_actes_disseminacio_participats:null,
    projectes_competitius_outreach:null,
    euros_projectes_competitius_outreach:null,
    aliances_solides_empreses_i_administracio_publica:null,
    projectes_i_encarrecs_ACA:null,
    accions_suport_tecnic_a_ACA_quimica_analitica:null,
    participants_tallers_UdG_ICRA:null,
    nombre_IPs:null,
    posicions_RF_creades:null,
    posicions_RS_estabilitzacio_RF:null,
    canvis_tram_RS_o_RP:null,
    sessions_JEDI_formacio_interna:null,
    participants_sessions_JEDI_formacio_interna:null,
    activitats_JEDI_organitzades:null,
    dones_categories_laborals_superiors:null,
    projectes_amb_administracio_central:null,
    euros_projectes_amb_administracio_central:null,
  };

  /*DEFINICIÓ INDICADORS*/
  let ambits=[
    new Ambit("Patronat",[
      new Bloc("Excel·lència en recerca",30,[                       /* pes  |24, 25, 26, 27, 28, 29| basal */
        new Indicador(`euros_recerca`,                                   10, [0,  2,  4,  6,  8, 10], 2995 ),
        new Indicador(`euros_recerca_horizon`,                            5, [0,  1,  2,  3,  4,  5], 1248 ),
        new Indicador(`euros_recerca_erc_eic`,                            5, [0,  0,  5, 50, 50, 50],   38 ),
        new Indicador(`euros_recerca_estatal`,                            5, [0,  1,  2,  3,  4,  5], 1189 ),
        new Indicador(`euros_recerca_regional` ,                          5, [0,  1,  2,  3,  4,  5],  518 ),
        new Indicador(`projectes_horizon`,                               10, [0,  1,  1,  2,  2,  2],    1 ),
        new Indicador(`projectes_erc_eic`,                             12.5, [0,  1,  2,  2,  2,  2],    1 ),
        new Indicador(`congressos_tallers_escoles_estiu_organitzats`,     5, [0,  5, 10, 10, 10, 15],    3 ),
        new Indicador(`sessions_especials_organitzades`,                  5, [0,  1,  2,  3,  4,  5],    4 ),
        new Indicador(`comites_internacionals_participats`,             2.5, [0,  5, 10, 10, 10, 15],    3 ),
        new Indicador(`articles_Q1`,                                      5, [0,  1,  2,  3,  4,  4],  105 ),
        new Indicador(`articles_Q1_amb_lideratge`,                        5, [0, 46, 48, 50, 52, 55],   45 ),
        new Indicador(`articles_D1`,                                      5, [0,  1,  2,  2,  3,  3],    1 ),
        new Indicador(`cites_articles`,                                  10, [0,  1,  2,  3,  4,  4],14215 ),
        new Indicador(`impact_factor`,                                    5, [0,  1,  2,  3,  4,  4],11.75 ),
        new Indicador(`estades_recercaires_acollits`,                   2.5, [0,  1,  2,  3,  4,  4],    5 ),
        new Indicador(`estades_recercaires_en_altres_centres`,          2.5, [0,  1,  2,  3,  4,  4],    1 ),
        new Indicador(`rati_exit_propostes_europa`,                       5, [0,  1,  2,  3,  4,  4],   20 ),
      ]),
      new Bloc("Promoure línies de recerca estratègiques",5,[
        new Indicador(`euros_recerca_L17_L18`,                           50, [0, 30, 30, 60, 60, 60], 0 ),
        new Indicador(`articles_Q1_L17_L18`,                             50, [0,  0,  5,  5, 10, 10], 0 ),
      ]),
      new Bloc("Promoure transferència",20,[
        new Indicador(`euros_projectes_KTT_respecte_total`,              10, [0, 13, 14, 16, 18, 18],  12 ),
        new Indicador(`euros_projectes_KTT`,                             30, [0, 20, 30, 40, 50, 60], 395 ),
        new Indicador(`projectes_KTT`,                                   15, [0,  5,  5, 10, 15, 20],  21 ),
        new Indicador(`formacions_per_empreses_organitzades`,            15, [0,  5, 10, 20, 25, 50],   3 ),
        new Indicador(`projectes_llavor_producte_innovadors`,            15, [0,  1,  2,  2,  2,  2],   0 ),
        new Indicador(`doctorats_industrials`,                           15, [0,  1,  2,  2,  3,  3],   0 ),
      ]),
      new Bloc("Promoure mecenatge",5,[
        new Indicador(`euros_mecenatge`,                                 70, [0, 20, 30, 40, 50, 60], 0 ),
        new Indicador(`projectes_mecenatge`,                             30, [0,  2,  3,  4,  4,  5], 0 ),
      ]),
      new Bloc("Generació PI, spin-offs, start-ups",5,[
        new Indicador(`patents_i_secrets_industrials`,                   20, [0, 1, 1,  2,  2,  2],  3 ),
        new Indicador(`spinoffs_i_startups`,                             40, [0, 1, 1,  1,  1,  2],  1 ),
        new Indicador(`articles_amb_socis_industrials`,                  40, [0, 5, 5, 10, 10, 15], 13 ),
      ]),
      new Bloc("Promoure impacte",20,[
        new Indicador(`estudiants_acollits`,                             10, [0, 10, 15, 20, 25, 30],  1 ),
        new Indicador(`cites_en_legislacio`,                             15, [0, 10, 15, 20, 25, 30], 87 ),
        new Indicador(`participacions_comites_experts_ambit_legislatiu`, 20, [0, 10, 15, 20, 25, 30],  3 ),
        new Indicador(`premis_nacionals`,                                 5, [0, 10, 15, 20, 25, 30],  1 ),
        new Indicador(`premis_internacionals`,                            5, [0, 10, 15, 20, 25, 30],  0 ),
        new Indicador(`narratives_impacte_CERCA`,                        15, [0,  1,  1,  2,  2,  3],  0 ),
        new Indicador(`contribucions_gestio_aigua`,                      10, [0,  0,  1,  1,  2,  2],  0 ),
        new Indicador(`llocs_de_treball_generats_llicencies`,             5, [0,  0,  1,  2,  2,  3],  0 ),
        new Indicador(`aliances_solides_entitats_socials`,               15, [0,  1,  2,  2,  3,  3],  1 ),
      ]),
      new Bloc("Promoure comunicació",10,[
        new Indicador(`xxss_seguidors`,                                25, [0,  10,  15,  20,  25,  30], 1164 ),
        new Indicador(`xxss_shares`,                                    5, [0,  10,  15,  20,  25,  30],  505 ),
        new Indicador(`xxss_plays`,                                    10, [0, 100, 200, 300, 500, 800],    0 ),
        new Indicador(`actes_disseminacio_participats_o_organitzats`,  15, [0,   5,  10,  15,  20,  20],    0 ),
        new Indicador(`aparicions_mitjans_comunicacio_nacionals`,      25, [0,  10,  15,  20,  25,  30],  197 ),
        new Indicador(`aparicions_mitjans_comunicacio_internacionals`, 20, [0,  10,  15,  20,  25,  30],   11 ),
      ]),
      new Bloc("Relació amb patrons",5,[
        //new Indicador(`reunions_taula_aigua_ACA`,                             5, [0,  9,  9,  9,  9,  9], 0),
        new Indicador(`hores_tasques_taula_aigua_ACA`,                         10, [0,300,400,500,550,600], 0),
        new Indicador(`euros_projectes_KTT_ACA`,                               25, [0, 10, 20, 30, 40, 45], 0),
        new Indicador(`tallers_UdG_ICRA`,                                      15, [0,  1,  1,  2,  2,  2], 0),
        new Indicador(`iniciatives_UdG_ICRA`,                                  15, [0,  1,  1,  2,  2,  2], 0),
        new Indicador(`euros_projectes_KTT_UdG`,                               25, [0,  0,  5,  5, 10, 10], 0),
        new Indicador(`participacions_activitats_JEDI_organitzades_per_CERCA`, 10, [0,  5, 10, 12, 15, 15], 0),
      ]),
    ]),
    new Ambit("Contracte Programa",[
      new Bloc("Excel·lència en recerca",30,[                       /* pes  |24, 25, 26, 27, 28, 29| basal */
        new Indicador(`euros_recerca`,                                   10, [0,  2,  4,  6,  8, 10], 2995 ),
        new Indicador(`euros_recerca_horizon`,                            5, [0,  1,  2,  3,  4,  5], 1248 ),
        new Indicador(`euros_recerca_erc_eic`,                            5, [0,  0,  5, 50, 50, 50],   38 ),
        new Indicador(`euros_recerca_estatal`,                            5, [0,  1,  2,  3,  4,  5], 1189 ),
        new Indicador(`euros_recerca_regional` ,                          5, [0,  1,  2,  3,  4,  5],  518 ),
        new Indicador(`projectes_horizon`,                               10, [0,  1,  1,  2,  2,  2],    1 ),
        new Indicador(`projectes_erc_eic`,                             12.5, [0,  1,  2,  2,  2,  2],    1 ),
        new Indicador(`congressos_tallers_escoles_estiu_organitzats`,     5, [0,  5, 10, 10, 10, 15],    3 ),
        new Indicador(`sessions_especials_organitzades`,                  5, [0,  1,  2,  3,  4,  5],    4 ),
        new Indicador(`comites_internacionals_participats`,             2.5, [0,  5, 10, 10, 10, 15],    3 ),

        new Indicador(`articles_Q1`,                                      5, [0,  1,  2,  3,  4,  4],  105 ),
        new Indicador(`articles_Q1_amb_lideratge`,                        5, [0, 46, 48, 50, 52, 55],   45 ),
        new Indicador(`articles_FWCI_10`,                                 5, [0,  1,  2,  2,  3,  3],    1 ),

        new Indicador(`cites_articles`,                                  10, [0,  1,  2,  3,  4,  4],14215 ),
        new Indicador(`impact_factor`,                                    5, [0,  1,  2,  3,  4,  4],11.75 ),
        new Indicador(`estades_recercaires_acollits`,                   2.5, [0,  1,  2,  3,  4,  4],    5 ),
        new Indicador(`estades_recercaires_en_altres_centres`,          2.5, [0,  1,  2,  3,  4,  4],    1 ),
        new Indicador(`rati_exit_propostes_europa`,                       5, [0,  1,  2,  3,  4,  4],   20 ),
      ]),
      new Bloc("Promoure línies de recerca estratègiques",5,[
        new Indicador(`euros_recerca_L17_L18`,                           50, [0, 30, 30, 60, 60, 60], 0 ),
        new Indicador(`articles_Q1_L17_L18`,                             50, [0,  0,  5,  5, 10, 10], 0 ),
      ]),
      new Bloc("Promoure transferència",20,[
        new Indicador(`euros_projectes_KTT_respecte_total`,              10, [0, 13, 14, 16, 18, 18],  12 ),
        new Indicador(`euros_projectes_KTT`,                             30, [0, 20, 30, 40, 50, 60], 395 ),
        new Indicador(`projectes_KTT`,                                   15, [0,  5,  5, 10, 15, 20],  21 ),
        new Indicador(`formacions_per_empreses_organitzades`,            15, [0,  5, 10, 20, 25, 50],   3 ),
        new Indicador(`projectes_llavor_producte_innovadors`,            15, [0,  1,  2,  2,  2,  2],   0 ),
        new Indicador(`doctorats_industrials`,                           15, [0,  1,  2,  2,  3,  3],   0 ),
      ]),
      new Bloc("Promoure mecenatge",5,[
        new Indicador(`euros_mecenatge`,                                 70, [0, 20, 30, 40, 50, 60], 0 ),
        new Indicador(`projectes_mecenatge`,                             30, [0,  2,  3,  4,  4,  5], 0 ),
      ]),
      new Bloc("Generació PI, spin-offs, start-ups",5,[
        new Indicador(`patents_i_secrets_industrials`,                   20, [0, 1, 1,  2,  2,  2],  3 ),
        new Indicador(`spinoffs_i_startups`,                             40, [0, 1, 1,  1,  1,  2],  1 ),
        new Indicador(`articles_amb_socis_industrials`,                  40, [0, 5, 5, 10, 10, 15], 13 ),
      ]),
      new Bloc("Promoure impacte",20,[
        new Indicador(`estudiants_acollits`,                             10, [0, 10, 15, 20, 25, 30],  1 ),
        new Indicador(`cites_en_legislacio`,                             15, [0, 10, 15, 20, 25, 30], 87 ),
        new Indicador(`participacions_comites_experts_ambit_legislatiu`, 20, [0, 10, 15, 20, 25, 30],  3 ),
        new Indicador(`premis_nacionals`,                                 5, [0, 10, 15, 20, 25, 30],  1 ),
        new Indicador(`premis_internacionals`,                            5, [0, 10, 15, 20, 25, 30],  0 ),
        new Indicador(`narratives_impacte_CERCA`,                        15, [0,  1,  1,  2,  2,  3],  0 ),
        new Indicador(`contribucions_gestio_aigua`,                      10, [0,  0,  1,  1,  2,  2],  0 ),
        new Indicador(`llocs_de_treball_generats_llicencies`,             5, [0,  0,  1,  2,  2,  3],  0 ),
        new Indicador(`aliances_solides_entitats_socials`,               15, [0,  1,  2,  2,  3,  3],  1 ),
      ]),
      new Bloc("Promoure comunicació",10,[
        new Indicador(`xxss_seguidors`,                                25, [0,  10,  15,  20,  25,  30], 1164 ),
        new Indicador(`xxss_shares`,                                    5, [0,  10,  15,  20,  25,  30],  505 ),
        new Indicador(`xxss_plays`,                                    10, [0, 100, 200, 300, 500, 800],    0 ),
        new Indicador(`actes_disseminacio_participats_o_organitzats`,  15, [0,   5,  10,  15,  20,  20],    0 ),
        new Indicador(`aparicions_mitjans_comunicacio_nacionals`,      25, [0,  10,  15,  20,  25,  30],  197 ),
        new Indicador(`aparicions_mitjans_comunicacio_internacionals`, 20, [0,  10,  15,  20,  25,  30],   11 ),
      ]),
      new Bloc("Relació amb patrons",5,[
        //new Indicador(`reunions_taula_aigua_ACA`,                             5, [0,  9,  9,  9,  9,  9], 0),
        new Indicador(`hores_tasques_taula_aigua_ACA`,                         10, [0,300,400,500,550,600], 0),
        new Indicador(`euros_projectes_KTT_ACA`,                               25, [0, 10, 20, 30, 40, 45], 0),
        new Indicador(`tallers_UdG_ICRA`,                                      15, [0,  1,  1,  2,  2,  2], 0),
        new Indicador(`iniciatives_UdG_ICRA`,                                  15, [0,  1,  1,  2,  2,  2], 0),
        new Indicador(`euros_projectes_KTT_UdG`,                               25, [0,  0,  5,  5, 10, 10], 0),
        new Indicador(`participacions_activitats_JEDI_organitzades_per_CERCA`, 10, [0,  5, 10, 12, 15, 15], 0),
      ]),
    ]),
    new Ambit("Pla d'Acció",[
      new Bloc("Pla d'Acció",0,[
        new Indicador(`eficiencia_articles_amb_socis_industrials`,         0,[30, 29, 27, 25] , 30   ),
        new Indicador(`objectius_assolits_del_pla_formacio`,               0,[ 0, 20, 70, 80] ,  0   ),
        new Indicador(`participants_actes_disseminacio_participats`,       0,[ 0,100,250,500] ,  0   ),
        new Indicador(`projectes_competitius_outreach`,                    0,[ 0,  0,  1,  2] ,  0   ),
        new Indicador(`euros_projectes_competitius_outreach`,              0,[ 0,  0, 10, 20] ,  0   ),
        new Indicador(`aliances_solides_empreses_i_administracio_publica`, 0,[ 5,  5, 10, 15] ,  5   ),
        new Indicador(`projectes_i_encarrecs_ACA`,                         0,[ 5,  5,  7, 10] ,  5   ),
        new Indicador(`accions_suport_tecnic_a_ACA_quimica_analitica`,     0,[ 0,  1,  3,  5] ,  0   ),
        new Indicador(`participants_tallers_UdG_ICRA`,                     0,[ 0,120,180,240] ,  0   ),
        new Indicador(`nombre_IPs`,                                        0,[16, 16, 18, 20] , 16   ),
        new Indicador(`posicions_RF_creades`,                              0,[ 0,  0,  2,  3] ,  0   ),
        new Indicador(`posicions_RS_estabilitzacio_RF`,                    0,[ 0,  0,  0,  1] ,  0   ),
        new Indicador(`canvis_tram_RS_o_RP`,                               0,[ 0,  0,  0,  8] ,  0   ),
        new Indicador(`sessions_JEDI_formacio_interna`,                    0,[ 0,  2,  4,  4] ,  0   ),
        new Indicador(`participants_sessions_JEDI_formacio_interna`,	     0,[ 5, 50, 80, 80] ,  5   ),
        new Indicador(`activitats_JEDI_organitzades`,	                     0,[ 0,  2,  5,  5] ,  0   ),
        new Indicador(`dones_categories_laborals_superiors`,               0,[37.5,37.5,40,42], 37.5 ),
        new Indicador(`projectes_amb_administracio_central`,               0,[ 0,  2,  5,  5] ,  0   ),
        new Indicador(`euros_projectes_amb_administracio_central`,         0,[ 0,  5, 15, 30] ,  0   ),
      ]),
    ]),
    new Ambit("IPs",[
      new Bloc("Excel·lència en recerca",30,[                       /* pes  |24, 25, 26, 27, 28, 29| basal */
        //TODO
      ]),
      new Bloc("Promoure transferència",20,[
        new Indicador(`euros_projectes_KTT`,                             30, [0, 20, 30, 40, 50, 60], 395 ),
        new Indicador(`formacions_per_empreses_organitzades`,            15, [0,  5, 10, 20, 25, 50],   3 ),
      ]),
      new Bloc("Generació PI, spin-offs, start-ups",5,[
        new Indicador(`patents_i_secrets_industrials`,                   20, [0, 1, 1,  2,  2,  2],  3 ),
        new Indicador(`spinoffs_i_startups`,                             40, [0, 1, 1,  1,  1,  2],  1 ),
        new Indicador(`articles_amb_socis_industrials`,                  40, [0, 5, 5, 10, 10, 15], 13 ),
      ]),
      new Bloc("Promoure impacte",20,[
        new Indicador(`estudiants_acollits`,                             10, [0, 10, 15, 20, 25, 30],  1 ),
        new Indicador(`cites_en_legislacio`,                             15, [0, 10, 15, 20, 25, 30], 87 ),
        new Indicador(`participacions_comites_experts_ambit_legislatiu`, 20, [0, 10, 15, 20, 25, 30],  3 ),
        new Indicador(`premis_nacionals`,                                 5, [0, 10, 15, 20, 25, 30],  1 ),
        new Indicador(`premis_internacionals`,                            5, [0, 10, 15, 20, 25, 30],  0 ),
        new Indicador(`narratives_impacte_CERCA`,                        15, [0,  1,  1,  2,  2,  3],  0 ),
      ]),
      new Bloc("Promoure comunicació",10,[
        new Indicador(`actes_disseminacio_participats_o_organitzats`,  15, [0,   5,  10,  15,  20,  20],    0 ),
        new Indicador(`aparicions_mitjans_comunicacio_nacionals`,      25, [0,  10,  15,  20,  25,  30],  197 ),
        new Indicador(`aparicions_mitjans_comunicacio_internacionals`, 20, [0,  10,  15,  20,  25,  30],   11 ),
      ]),
    ]),
    new Ambit("UdG professors",[
      new Bloc("Excel·lència en recerca",30,[                       /* pes  |24, 25, 26, 27, 28, 29| basal */
        //TODO
      ]),
      new Bloc("Promoure transferència",20,[
        new Indicador(`euros_projectes_KTT`,                             30, [0, 20, 30, 40, 50, 60], 395 ),
        new Indicador(`formacions_per_empreses_organitzades`,            15, [0,  5, 10, 20, 25, 50],   3 ),
      ]),
      new Bloc("Promoure impacte",20,[
        new Indicador(`estudiants_acollits`,                             10, [0, 10, 15, 20, 25, 30],  1 ),
        new Indicador(`cites_en_legislacio`,                             15, [0, 10, 15, 20, 25, 30], 87 ),
        new Indicador(`participacions_comites_experts_ambit_legislatiu`, 20, [0, 10, 15, 20, 25, 30],  3 ),
      ]),
      new Bloc("Promoure comunicació",10,[
        new Indicador(`actes_disseminacio_participats_o_organitzats`,  15, [0,   5,  10,  15,  20,  20],    0 ),
        new Indicador(`aparicions_mitjans_comunicacio_nacionals`,      25, [0,  10,  15,  20,  25,  30],  197 ),
        new Indicador(`aparicions_mitjans_comunicacio_internacionals`, 20, [0,  10,  15,  20,  25,  30],   11 ),
      ]),
    ]),
  ];
</script>

<script>
  /*finestra mobil per veure detalls*/
  let caption={
    visible:false,
    text:"caption text",
    actiu:false,

    show(ev, new_text){
      if(!this.actiu) return false;
      ev.stopPropagation(); //prevent parent elements triggering show()

      //new text is HTML
      if(new_text){
        caption.text=new_text;
      }

      this.visible=true;
      let el=document.querySelector("#caption");
      el.style.left=(ev.clientX-10)+"px";
      el.style.top=(ev.clientY+15)+"px";
    },
    hide(){
      if(!this.actiu) return false;
      this.visible=false;
    },
  };

  //configuracio columnes visibles i filtres per taules origen de dades
  class Conf_Taula{
    constructor(){
      this.taula    = null; //fetch_taula_undarius(nom_taula)
      this.columnes = {};   //sintaxi: "nom_columna" => true/false
      this.filtres  = {};   //sintaxi: "nom_columna" => valor (string o number) a filtrar
    }

    get columnes_actives(){
      //retorna els noms de les columnes actives
      return Object.entries(this.columnes).filter(en=>en[1]).map(en=>en[0]);
    }
    get files_filtrades(){
      //retorna les files de la taula que compleixen tots els filtres
      if(!this.taula) return [];

      let filtres = Object.entries(this.filtres);
      if(filtres.length==0) return this.taula;

      return this.taula.filter(row=>{
        let bool = false;
        return filtres.every(([key,val])=>row[key]==val);
      });
    }
  }
</script>

<script>//vue app
  let app = Vue.createApp({
    data(){return{
      years:[2023,2024/*,2025,2026,2027,2028,2029*/],
      ambits, //indicadors
      funcions_calculadores, //taula helper funcions dels indicadors

      carregant:true, //status

      ambit_actual:ambits[0], //"pestanyes"

      //veure detalls d'un sol indicador
      vista_detalls_indicador:false,
      html_detalls_indicador:false,
      caption,/*element <div id=caption> (finestreta detalls)*/

      //taules des d'on es calculen els indicadors: origens diversos (SQL icra, excels, ...)
      taules:{
        projectes:           new Conf_Taula(),
        personal:            new Conf_Taula(),
        esdeveniments:       new Conf_Taula(),
        tipus_esdeveniments: new Conf_Taula(),
        ingressos:           new Conf_Taula(),
        taula_aigua:         new Conf_Taula(),
        projectes_personal:  new Conf_Taula(),
      },
    }},

    methods:{
      calcular_tots_els_indicadors(){
        this.ambits.forEach(ambit=>{
          ambit.blocs.forEach(bloc=>{
            bloc.indicadors.forEach(indi=>{
              indi.calcula();
            });
          });
        });
      },

      //veure detalls indicador
      mousemove_indicador(event,indi,year){
        if(this.caption.actiu){
          let html = this.crea_html_caption(indi,year);
          this.caption.show(event, html);
        }
      },
      click_detalls_indicador(indi,year){
        this.vista_detalls_indicador=true;
        let html = this.crea_html_caption(indi,year);
        this.html_detalls_indicador=html;
      },
      //genera HTML per vista detalls indicador
      crea_html_caption(indi,year){
        let incr = indi.increment(year);
        let header=`
          <b>Detalls indicador</b>
          <p>
            <i>${indi.text}</i>
          </p>
          <p>Any: ${year}</p>
          <table border=1 small>
            <tr>
              <td>Valor (${year})</td>
              <td>${indi.years[year].valor} ${indi.unit}</td>
            </tr>
            <tr>
              <td>Valor basal (${indi.base_year})</td>
              <td>${indi.years[indi.base_year].valor} ${indi.unit}</td>
            </tr>
            <tr>
              <td>Canvi respecte valor basal</td>
              <td>${incr.delta} ${indi.unit} (${incr.perc.toFixed(0)}%)</td>
            </tr>
            <tr>
              <td>Objectiu ${year}</td>
              <td>+${incr.objectiu}%</td>
            </tr>
            <tr>
              <td>Compleix ${year}</td>
              <td>${incr.compleix?'Sí':'No'}</td>
            </tr>
          </table>
        `;
        let llista="";
        let arr = indi.years[year].llista;
        if(arr){
          llista+="<hr>";
          llista+=`Nombre d'elements: ${arr.length}`;
          llista+="<table border=1 xsmall>";
          arr.forEach((row,i)=>{
            if(i==0){
              llista+="<tr>";
              Object.entries(row).forEach(([key,_])=>{
                llista+=`
                  <th>
                    ${key}
                  </th>
                `;
              });
              llista+="</tr>";
            }
            llista+="<tr>";
            Object.entries(row).forEach(([_,val])=>{
              llista+=`
                <td>
                  ${val}
                </td>
              `;
            });
            llista+="</tr>";
          });
          llista+="</table>";
        }

        let ret=[
          header,
          llista,
        ].join("");

        return ret;
      },
    },

    computed:{
      //TODO
      get_ips(){
        if(!this.projectes) return false;
        if(!this.personal)  return false;

        let set = new Set();
        this.projectes.forEach(row=>{
          let estat = row["Situación del Proyecto"];
          let area  = row["Departament Àrea"];
          let nom   = row["IP Projecte"];
          if(area=="10. RECERCA" && nom){
            set.add(nom);
          }
        });
        let noms = Array.from(set).sort();
        let ips={};//retval dict
        noms.forEach(nom=>{
          ips[nom] = this.personal.filter(per=>per.Nom==nom);
        });
        return ips;
      },

      tot_carregat(){
        return Object.values(this.taules).every(obj=>obj.taula);
      },
    },
  }).mount("#app");

  //columnes activades per defecte
  app.taules.projectes.columnes={
    "Situación del Proyecto":true,
    "Título Abreviado":true,
    "Naturaleza del Proyecto":true,
    "Concurrencia":true,
  };
  app.taules.personal.columnes={
    "Nom":true,
    "Contracte":true,
  };
  app.taules.esdeveniments.columnes={
    "Esdeveniment":true,
    "Persona":true,
  };
  app.taules.tipus_esdeveniments.columnes={
    "Descripcio":true,
    "Observacions":true,
  };
  app.taules.ingressos.columnes={
    "Any":true,
    "Codi":true,
    "Ingressos":true,
  };
</script>

<script>
  //consulta SQL SERVER via node express instalat al cluster que consulta el server "srv-apps-03.icra.local"
  async function fetch_taula_undarius(nom_taula){
    //nom_taula: String
    try{
      //console.log(`llegint SQL server /${nom_taula}...`);

      let url=`https://undarius.icra.local:50000/${nom_taula}`;

      let response = await fetch(url);
      if(!response.ok){
        throw(`error fetching SQL Server (taula '${nom_taula}')`);
      }

      let data = await response.json();
      app.taules[nom_taula].taula = data;
      console.log(`OK GET /${nom_taula}`);
    }catch(err){
      console.error('Error fetching data:', err);
      app.carregant = false;
    }
  }
  //fetch_taula_undarius("projectes");
  fetch_taula_undarius("personal");
  fetch_taula_undarius("esdeveniments");
  fetch_taula_undarius("tipus_esdeveniments");
  fetch_taula_undarius("ingressos");
  fetch_taula_undarius("taula_aigua");
</script>

<script>
  //read excel file from url
  async function llegir_excel_projectes() {
    let url    = "csv/projectes.xlsx";
    let res    = await fetch(url);
    let blob   = await res.blob();
    let reader = new FileReader();
    let wb     = new ExcelJS.Workbook();

    function converteix_wb_a_taula_json(wb, index_sheet){
      index_sheet = index_sheet || 0;

      let taula=[];//retval

      //noms columnes: valors primera fila
      let noms_columnes = wb.worksheets[index_sheet]._rows[0].values;

      //omple la taula
      wb.worksheets[index_sheet]._rows.forEach((row,i)=>{
        if(i==0) return; //skip primera fila
        let new_row={};
        noms_columnes.forEach((key,j)=>{
          let val = row.values[j];
          new_row[key]=val;
        });
        taula.push(new_row);
      });

      return taula;
    }

    reader.readAsArrayBuffer(blob);
    reader.onload=async function(){
      let buffer = reader.result;
      await wb.xlsx.load(buffer);

      //l'excel "projectes" té 2 sheets:
      let projectes          = converteix_wb_a_taula_json(wb, 0);
      let projectes_personal = converteix_wb_a_taula_json(wb, 1);

      app.taules.projectes.taula          = projectes;
      app.taules.projectes_personal.taula = projectes_personal;
      /*
        wb.worksheets (array)
        sheet.columns (array)
        column.values (array)
        value._number
      */
    };
  }
  llegir_excel_projectes();
</script>
