<!doctype html><html><head>
  <title>ICRA indicadors</title>
  <meta charset="utf8">

  <!--lib vue-->
  <script src="lib/vue.global.prod.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"
    integrity="sha512-dlPw+ytv/6JyepmelABrgeYgHI0O+frEwgfnPdXDTOIZz+eDgfW07QXG02/O8COfivBdGNINy+Vex+lYmJ5rxw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>
  <script src="lib/run_prettify.js"></script>

  <style>
    body{
      font-family: Eczar, IM Fell English, Georgia, serif;
    }
    table{
      border-collapse:collapse;
    }
    td,th{
      padding:1px;
    }
    summary:hover{
      cursor:pointer;
      text-decoration:underline;
    }
    label:hover{
      background:lightyellow;
    }
    [bold]{
      font-weight:bold;
    }
    [small]{
      font-size:smaller;
    }
    [xsmall]{
      font-size:x-small;
    }
    [large]{
      font-size:larger;
    }
    [center]{
      text-align:center;
    }
    [right]{
      text-align:right;
    }
    [left]{
      text-align:left;
    }
    [monospace]{
      font-family:monospace;
    }
    [nom_bloc]{
      color:darkblue;
      cursor:pointer;
    }
    [nom_bloc]:hover{
      text-decoration:underline;
    }
    [nowrap]{
      white-space:nowrap;
    }
    [vista_detalls_indicador]{
      border:1px solid #ccc;
      background:lightyellow;
      box-shadow:1px 1px 10px #ccc;
      padding:5px;
    }
    button[ambit_actual=true]{
      background:royalblue;
      color:white;
    }
    [filtre_responsable_actual=true]{
      background:royalblue;
      color:white;
    }
    [sticky]{
      position:sticky;
      top:0;
    }
    tr[sticky] > th,
    tr[sticky] > td {
      position:sticky;
      top:0;
      background:white;
    }
    button[btn_calcular_tots]{
      background:gold;
      border:1px solid #666;
      border-radius:5px;
    }
    button[btn_calcular_tots]:active{
      border-style:inset;
    }
    button[btn_calcular_tots]:hover{
      background:rgba(255,215,0,0.75);
    }
    [indicador_text]:hover{
      text-decoration:underline;
      cursor:pointer;
    }
    [marcat="1"]{
      background:gold;
    }
    button[ip_seleccionat=true]{
      background:gold;
    }
  </style>
  <script>
    Array.prototype.suma=function(){
      return this.reduce((p,c)=>p+c,0);
    }
  </script>
<head></head><body>

<!--nav--><div id=nav></div><hr><script src="nav.js"></script>

<div id=app>
  <h2>
    <div style="display:flex;justify-content:space-between">
      <div>Indicadors ICRA</div>
      <div>
        <button @click="debug=!debug" xsmall>mode debug {{debug?"ON":"OFF"}}</button>
      </div>
    </div>
  </h2>

  <!--avís certificat-->
  <div v-if="!tot_carregat"><hr>
    Perquè tot funcioni cal:<ol>
      <li>
        Estar dins la xarxa de l'ICRA (o a la VPN)
      </li>
      <li>
        Descarregar i importar aquest certificat:
        <a href="https://undarius.icra.local:50000/server.cert">certificat HTTPS Undarius</a>
      </li>
    </ol><hr>
  </div>

  <!--finestra detalls indicador-->
  <div v-if="vista_detalls_indicador" vista_detalls_indicador id=detalls>
    <div sticky>
      <button
        @click="vista_detalls_indicador=false"
        title="Tancar finestra detalls"
        style="padding:0.618em 1em"
        v-html="'X'"
      />
    </div>
    <div v-html="html_detalls_indicador"></div>
  </div>

  <!--secció indicadors-->
  <details open>
    <summary large bold>
      Indicadors "{{ambit_actual.nom}}"
      <small>
        ({{ambit_actual.blocs.map(b=>b.indicadors.length).suma()}} indicadors)
      </small>
    </summary>

    <!--àmbits pestanyes-->
    <p style="display:flex;align-items:center">
      <button
        v-for="ambit in ambits"
        @click="ambit_actual=ambit"
        :ambit_actual="ambit==ambit_actual"
      >{{ambit.nom}}</button>

      <span>&emsp;</span>

      <span>Anys analitzats:</span>
      <label v-for="year in Object.keys(selected_years)">
        <input type=checkbox v-model="selected_years[year]">{{year}}
      </label>
    </p>

    <!--opcions-->
    <p>
      <label>
        <input type=checkbox v-model="veure_responsable">
        Veure columna "Responsable"
      </label>
      <label>
        <input type=checkbox v-model="veure_percentatge">
        Veure variació (%) respecte 2023
      </label>
      <label>
        <input type=checkbox v-model="veure_boto_detalls">
        Veure botó "detalls"
      </label>
    </p>

    <!--opcions indicadors IPs-->
    <div v-if="ambit_actual.nom=='IPs' || ambit_actual.nom=='UdG professors'">
      <p v-if="false">
        Mode visualització indicadors IPs:
        <label><input type=radio v-model="mode_visualitzacio_indicadors_ips" value="ip_vs_indicadors"> 1 IP vs indicadors</label>
        <label><input type=radio v-model="mode_visualitzacio_indicadors_ips" value="indicador_vs_ips"> 1 indicador vs IPs</label>
        <label><input type=radio v-model="mode_visualitzacio_indicadors_ips" value="tots_vs_tots">     tots vs tots</label>
      </p>

      <details open style="margin-bottom:10px">
        <summary>
          <span v-if="!ip_seleccionat">Selecciona IP</span>
          <span v-if="ip_seleccionat">
            IP seleccionat: <b>{{ip_seleccionat.nom}}</b>
            &nbsp;
            <button @click="ip_seleccionat=null">X</button>
          </span>
        </summary>
        <div
          style="
            display:grid;
            grid-template-columns:repeat(5,1fr);
            grid-gap:1px 3px;
          "
        >
          <div v-for="ip in {'IPs':get_ips,'UdG professors':get_professors}[ambit_actual.nom]()">
            <button
              @click="ip_seleccionat=ip;calcular_tots_els_indicadors()"
              :ip_seleccionat="ip_seleccionat && ip.nom==ip_seleccionat.nom"
              style="width:100%"
            >{{ip.nom}}
            </button>
          </div>
        </div>
      </details>
    </div>

    <table border=1>
      <tr sticky>
        <th>Pes</th>
        <th left>Blocs</th>
        <td small center>Unitat</td>
        <td center title="Departament responsable" small v-if="veure_responsable">
          <details>
            <summary style="list-style:none">Responsable</summary>
            <div v-for="res in get_responsables">
              <button
                @click="filtre_responsable=res"
                :filtre_responsable_actual="filtre_responsable==res"
                xsmall
              >{{res}}
              </button>
            </div>
          </details>
          <button @click="filtre_responsable=false" v-if="filtre_responsable" small>
            X[eliminar filtre]
          </button>
        </td>
        <td v-for="year in years" center>
          <span>{{year}}</span>
        </td>
        <th>
          <button
            @click="calcular_tots_els_indicadors()"
            :disabled="!tot_carregat"
            btn_calcular_tots
          >calcular tots</button>
        </th>
      </tr>
      <tbody v-for="bloc,i in ambit_actual.blocs">
        <tr style="background:#eee;">
          <td right small><b>{{bloc.pes_percent}}%</b></td>

          <!--bloc nom-->
          <td>
            <b nom_bloc @click="bloc.visible^=1">
              <span style="font-family:monospace">
                <span v-if="bloc.visible">[-] </span>
                <span v-if="!bloc.visible">[+] </span>
              </span>
              <span>{{i+1}}. {{bloc.nom}}</span>
              <small> ({{bloc.indicadors.length}} ind.)</small>
            </b>
          </td>

          <td></td>

          <td v-if="veure_responsable"></td>

          <td v-for="year in years" center monospace title="Puntuació" style="color:darkblue">
            <b v-if="false">{{bloc.puntuacio(year).toFixed(1)}}</b>
          </td>
          <td></td>
        </tr>

        <!--itera indicadors-->
        <tr
          v-for="indi,j in bloc.indicadors.filter(i=>!filtre_responsable || i.responsable==filtre_responsable)"
          v-if="bloc.visible"
          :marcat="indi.marcat"
        >
          <td xsmall right>{{indi.pes_percent}}%</td>

          <!--text indicador-->
          <td small @click="indi.marcat^=1" indicador_text>
            <div>
              <span>{{i+1}}.{{j+1}}.</span>

              <!--text indicador-->
              <span v-if="!indi.marcat">
                <span :title="`${indi.text} (${indi.id})`">{{indi.text.slice(0,100)}}</span>
                <span v-if="indi.text.length>100">...</span>
              </span>
              <span v-if="indi.marcat">
                {{indi.text}}
              </span>
            </div>
          </td>

          <!--indicador unitat-->
          <td center>
            <div xsmall style="color:#666" v-if="indi.unit">{{indi.unit}}</div>
          </td>

          <!--indicador responsable-->
          <td v-if="veure_responsable" center xsmall>
            <span @click="filtre_responsable=indi.responsable">{{indi.responsable}}</span>
          </td>

          <!--indicador valors de cada anhy-->
          <td v-for="year in years" center small nowrap monospace>
            <div v-for="obj in [indi.years[year]]">
              <div v-for="incr in [indi.increment(year)]">
                <div
                  style="
                    display:flex;
                    justify-content:space-around;
                    align-items:center;
                  "
                >
                  <!--valor indicador-->
                  <div right>{{obj.valor.toFixed(0)}}</div>

                  <!--increment i objectiu-->
                  <div
                    v-if="veure_percentatge && !obj.excloure && funcions_calculadores[indi.funcio_calculadora]"
                    small right
                    :title="`Variació respecte valor basal (${indi.base_year})`"
                  >
                    <span :style="{color:incr.compleix?'green':'red'}">
                      <span v-if="incr.delta>0">&uarr;</span>
                      <span v-if="incr.delta<0">&darr;</span>
                      <span v-if="isFinite(incr.perc)">
                        {{Math.abs(incr.perc).toFixed(0)}}%
                      </span>
                      <span v-else>
                        <span large>∞</span>%
                      </span>
                    </span>
                  </div>

                  <!--boto veure detalls-->
                  <div v-if="!obj.excloure && funcions_calculadores[indi.funcio_calculadora] && veure_boto_detalls" small right>
                    <button
                      @click="click_detalls_indicador(indi,year)"
                      style="padding:0;font-size:x-small"
                    >detalls</button>
                  </div>
                </div>
              </div>
            </div>
          </td>

          <!--indicador botó calcular-->
          <td center>
            <button
              v-if="funcions_calculadores[indi.funcio_calculadora]"
              @click="indi.calcula()"
              xsmall
              :disabled="!tot_carregat"
              style="display:block"
              >
              calcular indicador
            </button>
            <span v-else xsmall style="color:#bbb">pendent</span>
          </td>
        </tr>
      </tbody>
    </table>
  </details>

  <!--taules dev "Conf_Taula"-->
  <details v-if="debug" open>
    <summary large bold>
      [dev] Taules desenvolupament
    </summary>
    <!--itera taules-->
    <div v-for="taula in Object.keys(taules)">
      <details :id="`container_taula_${taula}`">
        <summary large bold style="margin-left:1em;color:#555">
          Taula {{taula}}
          <span v-if="taules[taula].taula" small>
            ({{taules[taula].files_filtrades.length}}/{{taules[taula].taula.length}} items)
          </span>
        </summary>

        <div v-if="!taules[taula].taula">carregant "{{taula}}"...</div>
        <div v-if="!taules[taula].taula && !carregant">error consulta SQL Server ICRA</div>

        <code v-if="taules[taula].comentaris" style="margin-left:1em">
          {{taules[taula].comentaris}}
        </code>

        <!--checkboxes per veure columnes-->
        <p v-if="taules[taula].taula?.length" small>
          <label v-for="val,key in taules[taula].taula[0]">
            <input type=checkbox v-model="taules[taula].columnes[key]">
            <span :style="{color:taules[taula].filtres[key]!=undefined?'blue':''}">{{key}}</span>
          </label>
        </p>

        <table border=1 v-if="taules[taula].taula?.length" small>
          <thead>
            <tr sticky>
              <th v-for="key in taules[taula].columnes_actives">
                <button @click="taules[taula].taula.sort((a,b)=>a[key]>b[key]?1:-1)">&darr;{{key}}</button>
                <button v-if="taules[taula].filtres[key]!=undefined" @click="delete taules[taula].filtres[key]">
                          ="{{String(taules[taula].filtres[key]).substring(0,50)}}"
                </button>
                <button @click="taules[taula].columnes[key]=false">X</button>
              </th>
              <th>
                <a :href="`#container_taula_${taula}`">
                  #taula_{{taula}}
                </a>
              </th>
            </tr>
          </thead>
          <tr v-for="row in taules[taula].files_filtrades">
            <td v-for="key in taules[taula].columnes_actives">
              <span @click="taules[taula].filtres[key]=row[key]">{{row[key]}}</span>
            </td>
          </tr>
        </table>
      </details>
    </div>
  </details>

  <!--taula_resum_esdeveniments-->
  <details v-if="debug && taula_resum_esdeveniments">
    <summary large bold>
      [dev] Taula resum esdeveniments-IPs
    </summary>
    <ul
      v-for="[a,b] in [[
        taula_resum_esdeveniments.map(row=>row.esdeveniments.length).suma(),
        taules.esdeveniments.taula.length,
      ]]"
    >
      <li>Hi ha {{b}} esdeveniments ("totals").
      <li>Hi ha {{a}} esdeveniments associats a IPs ("correctes").
      <li>La diferència ({{b-a}} esdeveniments) no estan associats a IPs.
    </ul>

    <table border=1>
      <tr>
        <th>ip</th>
        <th>esdeveniments</th>
      </tr>
      <tr v-for="row in taula_resum_esdeveniments">
        <td>{{row.ip.nom}}</td>
        <td>
          <details>
            <summary>{{row.esdeveniments.length}} esdeveniments</summary>
            <table border=1 small style="margin-left:5px">
              <tr v-for="esd in row.esdeveniments">
                <td>
                  <details>
                    <summary>
                      [{{new Date(esd.DataInici_Esdeveniment).getFullYear()}}]
                      {{esd.Esdeveniment}}
                    </summary>
                    <table style="margin-left:5px">
                      <tr v-for="val,key in esd">
                        <td>{{key}}</td>
                        <td>{{val}}</td>
                      </tr>
                    </table>
                  </details>
                </td>
              </tr>
            </table>
          </details>
        </td>
      </tr>
    </table>
  </details>

</div>

<script>//classes i dades
  /*classe àmbit: conjunt de blocs*/
  class Ambit{
    constructor(nom, blocs){
      this.nom=nom||"nom àmbit";
      this.blocs=blocs||[]; //array objectes {Bloc}
    }
  }

  /*classe bloc: conjunt d'indicadors*/
  class Bloc{
    constructor(nom, pes_percent, indicadors){
      this.nom         = nom;
      this.pes_percent = pes_percent;
      this.indicadors  = indicadors||[]; //array objectes {Indicador}

      //GUI opcions
      this.visible=1;
    }

    //suma puntuació de tots els indicadors
    puntuacio(year){
      return this.indicadors.map(i=>i.puntuacio(year)).suma();
    }
  }

  /*classe indicador: objecte principal*/
  class Indicador{
    constructor(id, pes_percent, objectius, valor_basal){
      objectius   = objectius   ||[]; //array percentatges
      valor_basal = valor_basal ||[]; //array valors precalculats

      this.id          = id;               //string
      this.text        = textos[id];       //string
      this.unit        = unitats[id];      //string
      this.pes_percent = pes_percent || 0; //number
      this.responsable = responsables[id]; //string

      if(!this.text) throw(`no text for ${id}`)

      this.base_year="2023"; //String

      //funció que calcula l'indicador per un determinat any. Modifica this.years[year][valor i llista]
      this.funcio_calculadora = id; //String

      //Cada indicador té varis anys:
      //  valor    : numero, valor cru de l'indicador en sí per aquell any
      //  llista   : array des d'on es calcula el valor. El genera la funció calculadora
      //  objectiu : numero (percentatge que cal assolir)
      //  excloure : per l'any basal no mostrar indicadors
      this.years={
        "2023":{valor:valor_basal[0]||0, llista:null, objectiu:0, excloure:true},
        "2024":{valor:valor_basal[1]||0, llista:null, objectiu:objectius[0]||0},
        "2025":{valor:valor_basal[2]||0, llista:null, objectiu:objectius[1]||0},
        "2026":{valor:valor_basal[3]||0, llista:null, objectiu:objectius[2]||0},
        "2027":{valor:valor_basal[4]||0, llista:null, objectiu:objectius[3]||0},
        "2028":{valor:valor_basal[5]||0, llista:null, objectiu:objectius[4]||0},
        "2029":{valor:valor_basal[6]||0, llista:null, objectiu:objectius[5]||0},
      };

      //visual
      this.marcat=false;
    }

    //calcula puntuació indicador
    puntuacio(year){
      let pes = this.pes_percent/100;
      let val = this.years[year] ? this.years[year].valor : 0;
      let punts = pes*val;
      return punts;
    }

    increment(year){
      let base     = this.years[this.base_year].valor||0; //number valor base
      let curr     = this.years[String(year)].valor||0;   //number valor actual
      let delta    = curr - base;                         //number diferencia
      let perc     = 100*delta/base||0;                   //number diferencia (%)
      let objectiu = this.years[year].objectiu;           //number objectiu (%)
      let compleix = perc >= objectiu;                    //bool   compleix
      return {delta,perc,objectiu,compleix};
    }

    //calcula indicador a tots els anys
    calcula(){
      if(!app.tot_carregat){
        let msg="impossible calcular indicador";
        alert(msg);
        throw(msg);
        return 0;
      };
      let id = this.funcio_calculadora;
      if(!app.funcions_calculadores[id]){
        return false;
      }

      Object.entries(this.years)
        .filter(e=>!e[1].excloure).map(e=>e[0])
        .forEach(year=>{
          if(app.selected_years[year]){
            app.funcions_calculadores[id](year, this);
          }
        });
    }

    get selected_years(){
      return app.years;
    }
  }

  /*taules helper*/

  //taula: "id_indicador"=>"text indicador"
  let textos={
    "euros_recerca"                                         : `Aportació econòmica total a través de projectes o contractes de recerca`,
    "euros_recerca_horizon"                                 : `Aportació econòmica de projectes de recerca competitius Europeus (Horizon)`,
    "euros_recerca_erc_eic"                                 : `Aportació econòmica de projectes de recerca competitius Europeus (ERC-EIC)`,
    "euros_recerca_estatal"                                 : `Aportació econòmica de projectes de recerca competitius estatals (AEI-ERANETs)`,
    "euros_recerca_regional"                                : `Aportació econòmica de projectes de recerca competitius regionals (ACA-AGAUR)`,
    "projectes_horizon"                                     : `Projectes de recerca competitius vigents tipus Horizon coordinats`,
    "projectes_erc_eic"                                     : `Projectes de recerca competitius vigents tipus ERC o EIC`,
    "congressos_tallers_escoles_estiu_organitzats"          : `Congressos/tallers/escoles d'estiu i altres activitats internacionals de recerca organitzats per ICRA`,
    "sessions_especials_organitzades"                       : `Sessions especials en congressos organitzades per ICRA`,
    "comites_internacionals_participats"                    : `Comitès internacionals (i.e. SAB/panell d'avaluació/expert group...) participats per ICRA`,
    "articles_Q1"                                           : `Articles científics al Q1 (segons Scopus)`,
    "articles_Q1_amb_lideratge"                             : `Articles científics al Q1 (segons Scopus) amb lideratge ICRA (primer, darrer, o autor de correspondència)`,
    "articles_D1"                                           : `Articles científics al D1 (segons Scopus)`,
    "articles_FWCI_10"                                      : `Articles científics influents amb un factor d'impacte ponderat per cites (FWCI>10, segons Scopus)`,
    "cites_articles"                                        : `Cites anuals (segons Scopus)`,
    "impact_factor"                                         : `Índex d'impacte (Impact factor) de la institució (segons Scopus) en el moment de l'anàlisi`,
    "estades_recercaires_acollits"                          : `Estades de recercaires (predocs, postdocs, seniors) internacionals a ICRA`,
    "estades_recercaires_en_altres_centres"                 : `Estades de recercaires ICRA (predocs, postdocs, seniors) en centres internacionals`,
    "rati_exit_propostes_europa"                            : `Rati d'èxit de les propostes de recerca competitives Europees (Horizon, ERC, EIC)`,
    "euros_recerca_L17_L18"                                 : `Aportació econòmica total a través de projectes o contractes de recerca a les noves línies L17 i L18`,
    "articles_Q1_L17_L18"                                   : `Articles científics al Q1 (segons Scopus) associats a la L17 i la L18`,
    "euros_projectes_KTT_respecte_total"                    : `Percentatge d'aportacions de projectes/contractes de recerca tipus KTT respecte el total de les aportacions per recerca (competitius+KTT+mecenatge)`,
    "euros_projectes_KTT"                                   : `Aportació econòmica a través de projectes/contractes tipus KTT`,
    "projectes_KTT"                                         : `Projectes/contractes tipus KTT en curs`,
    "formacions_per_empreses_organitzades"                  : `Formacions/tallers per empreses/administracions organitzats per ICRA`,
    "projectes_llavor_producte_innovadors"                  : `Projectes en l'àmbit de la indústria de coneixement (Llavor, Producte, Innovadors, EIC, o equivalents)`,
    "doctorats_industrials"                                 : `Doctorats industrials en curs`,
    "euros_mecenatge"                                       : `Aportació econòmica a través de projectes de recerca per mecenatge`,
    "projectes_mecenatge"                                   : `Projectes de recerca per mecenatge`,
    "patents_i_secrets_industrials"                         : `Patents/secrets industrials en tramitació o vigents`,
    "spinoffs_i_startups"                                   : `Spin-offs o start-ups amb participació d'ICRA en curs`,
    "articles_amb_socis_industrials"                        : `Percentatge articles científics amb socis industrials (no acadèmics) com a co-autors`,
    "estudiants_acollits"                                   : `Estudiants d'ESO o Batxillerat acollits o mentoritzats des d'ICRA`,
    "cites_en_legislacio"                                   : `Cites en legislació (segons Sage Policy Profiles, sagepub.com)`,
    "participacions_comites_experts_ambit_legislatiu"       : `Participacions en comitès d'experts en l'àmbit legislatiu i de gestió de l'aigua`,
    "premis_nacionals"                                      : `Premis/reconeixements a nivell regional/estatal`,
    "premis_internacionals"                                 : `Premis/reconeixements a nivell internacional`,
    "narratives_impacte_CERCA"                              : `Narratives d'impacte sotmeses a CERCA i avaluades amb un excel·lent o outstanding`,
    "contribucions_gestio_aigua"                            : `Contribucions a canvis en la gestió de l'aigua a les conques internes de Catalunya`,
    "llocs_de_treball_generats_llicencies"                  : `Llocs de treball generats mitjançant llicències amb participació d'ICRA`,
    "aliances_solides_entitats_socials"                     : `Aliances sòlides amb entitats que tinguin una finalitat social (ambientals, esportives, culturals, educatives)`,
    "xxss_seguidors"                                        : `Seguidors/subscriptors a les xarxes socials d'ICRA`,
    "xxss_shares"                                           : `Comparticions (shares, retweets) a les xarxes socials d'ICRA`,
    "xxss_streams"                                          : `Visualitzacions de sessions de streaming realitzades a les xarxes socials d'ICRA`,
    "actes_disseminacio_participats_o_organitzats"          : `Actes de disseminació participats o organitzats per ICRA`,
    "aparicions_mitjans_comunicacio_nacionals"              : `Aparicions en els mitjans de comunicació escrits i audiovisuals regionals o estatals`,
    "aparicions_mitjans_comunicacio_internacionals"         : `Aparicions en els mitjans de comunicació escrits i audiovisuals internacionals`,
    "reunions_taula_aigua_ACA"                              : `Reunions de la Taula de l'Aigua amb l'ACA`,
    "hores_tasques_taula_aigua_ACA"                         : `Hores computades per IPs a tasques associades a la taula de l'Aigua`,
    "euros_projectes_KTT_ACA"                               : `Aportacions de projectes o contractes de KTT amb l'ACA, via contracte programa o licitació`,
    "tallers_UdG_ICRA"                                      : `Organitzacions i participacions en tallers UdG-ICRA per enfortir col·laboració en marc de l'aigua`,
    "iniciatives_UdG_ICRA"                                  : `Iniciatives de recerca conjuntes UdG-ICRA`,
    "euros_projectes_KTT_UdG"                               : `Aportació econòmica de projectes o contractes de KTT conjuntament amb UdG`,
    "participacions_activitats_JEDI_organitzades_per_CERCA" : `Participació en actes/activitats organitzades per DREU/CERCA en l'àmbit de 'Dones i Ciència'/'Ciència a les escoles' o similars`,
    "eficiencia_articles_amb_socis_industrials"             : `Eficiència articles amb socis industrials o de l'administració pública respecte ingressos`,
    "objectius_assolits_del_pla_formacio"                   : `Objectius del pla de formació anual assolits`,
    "participants_actes_disseminacio_participats"           : `Participants en actes de disseminació participats per ICRA`,
    "projectes_competitius_outreach"                        : `Projectes singulars competitius per desenvolupar activitats d'outreach`,
    "euros_projectes_competitius_outreach"                  : `Aportació econòmica en projectes competitius per activitats d'outreach`,
    "aliances_solides_empreses_i_administracio_publica"     : `Aliances sòlides amb empreses i administració pública`,
    "projectes_i_encarrecs_ACA"                             : `Projectes/encàrrecs directes de l'ACA`,
    "accions_suport_tecnic_a_ACA_quimica_analitica"         : `Accions de suport tècnic ofertes a l'ACA en temes de química analítica`,
    "participants_tallers_UdG_ICRA"                         : `Participants en tallers/seminaris UdG-ICRA`,
    "nombre_IPs"                                            : `Nombre d'IPs`,
    "posicions_RF_creades"                                  : `Posicions de Research Fellow creades`,
    "posicions_RS_estabilitzacio_RF"                        : `Noves posicions de Research Scientist per estabilització de Research Fellows`,
    "canvis_tram_RS_o_RP"                                   : `Canvis de tram dins d'una mateixa categoria de Research Scientist o Research Professor`,
    "sessions_JEDI_formacio_interna"                        : `Sessions de formació interna per personal ICRA per fomentar valors JEDI`,
    "participants_sessions_JEDI_formacio_interna"           : `Proporció del personal que participa les formacions del JEDI anualment`,
    "activitats_JEDI_organitzades"                          : `Organització d'activitats per fomentar valors JEDI en la recerca`,
    "dones_categories_laborals_superiors"                   : `Percentatge de dones en categories laborals superiors o amb càrrecs de gestió i lideratge (IPs i caps de departament)`,
    "projectes_amb_administracio_central"                   : `Projectes/contractes/comitès amb participació d'ICRA i de l'administració central de l'estat`,
    "euros_projectes_amb_administracio_central"             : `Aportació econòmica en contractes de recerca amb l'administració central de l'estat`,

    //textos indicadors ip
    "ips_euros_recerca"                                   :"Aportació econòmica total a través de projectes competitius Europeus, estatals i regionals com IP o co-IP",
    "ips_projectes_erc_eic"                               :"Projectes de recerca (ERC/EIC, amb pressupost superior a 1 M€) aconseguits",
    "ips_projectes_coordinats_5_socis_2M"                 :"Projectes de recerca competitius coordinats (Horizon IA, RIA, DN i altres amb més de 5 socis i pressupost total superior a 2 M€) aconseguits",
    "ips_projectes_coordinats_4_socis_1M"                 :"Projectes de recerca competitius coordinats (JPI, LIFE i altres amb més de 4 socis i pressupost total superior a 1 M€) aconseguits",
    "ips_projectes_IP_o_COIP"                             :"Projectes de recerca competitius Europeus, estatals i regionals (IP o co-IP)",
    "ips_projectes_participant"                           :"Projectes de recerca competitius Europeus, estatals i regionals (participant)",
    "ips_congressos_tallers_escoles_estiu_organitzats"    :"Congressos/tallers/escoles d'estiu/sessions especials en congressos i altres activitats internacionals de recerca organitzats",
    "ips_conferencies_convidades"                         :"Conferències convidades (plenàries, keynote).",
    "ips_comites_internacionals_participats"              :"Comitès internacionals (i.e. SAB/panell d'avaluació/expert group) participats",
    "ips_articles_Q1"                                     :"Articles científics al Q1 (segons Scopus) aconseguits",
    "ips_articles_D1_percentatge"                         :"Percentatge d'articles científics al D1 aconseguits",
    "ips_articles_FWCI_10"                                :"Articles d'alt impacte (FWCI>10) aconseguits",
    "ips_treball_editorial_Q1"                            :"Treball editorial (com a Editor en Cap o Editor Associat) en revistes Q1",
    "ips_tesis_doctorals"                                 :"Tesis doctorals defensades",
    "ips_postdocs_supervisats"                            :"Postdocs (>6 mesos) supervisats",
    "ips_estades_recercaires_acollits"                    :"Estades de recercaires (predocs, postdocs, visiting scientist) acollits en estades de recerca (>3 mesos)",
    "ips_euros_projectes_KTT"                             :"Aportació econòmica a través de projectes/contractes tipus KTT com IP o co-IP",
    "ips_formacions_per_empreses_organitzades"            :"Formacions/tallers per empreses/administracions organitzats",
    "ips_patents_i_secrets_industrials"                   :"Patents/secrets industrials en tramitació o vigents",
    "ips_spinoffs_i_startups"                             :"Spin-offs o start-ups amb participació d'ICRA vigents",
    "ips_articles_amb_socis_industrials"                  :"Percentatge d'articles científics amb socis industrials (no acadèmics) com a co-autors",
    "ips_estudiants_acollits"                             :"Estudiants d'ESO, Batxillerat, FP, TFG, TFM mentoritzats des d'ICRA",
    "ips_cites_en_legislacio"                             :"Cites en legislació  (Sage Policy Profiles)",
    "ips_participacions_comites_experts_ambit_legislatiu" :"Participacions en comitès d'experts en l'àmbit legislatiu i de gestió de l'aigua",
    "ips_premis_nacionals_i_internacionals"               :"Premis internacionals o nacionals",
    "ips_narratives_impacte_CERCA"                        :"Narratives d'impacte sotmeses a CERCA i avaluades amb un excel·lent o outstanding",
    "ips_actes_disseminacio_participats_o_organitzats"    :"Actes de disseminació participats o organitzats",
    "ips_aparicions_mitjans_comunicacio_nacionals"        :"Aparicions en mitjans de comunicació regionals o estatals",
    "ips_aparicions_mitjans_comunicacio_internacionals"   :"Aparicions en mitjans de comunicació internacionals",
  };

  //taula: "id_indicador"=>"unitat indicador"
  let unitats={
    "euros_recerca"                                         : `k€`,
    "euros_recerca_horizon"                                 : `k€`,
    "euros_recerca_erc_eic"                                 : `k€`,
    "euros_recerca_estatal"                                 : `k€`,
    "euros_recerca_regional"                                : `k€`,
    "projectes_horizon"                                     : `projectes`,
    "projectes_erc_eic"                                     : `projectes`,
    "congressos_tallers_escoles_estiu_organitzats"          : `activitats`,
    "sessions_especials_organitzades"                       : `sessions`,
    "comites_internacionals_participats"                    : `comitès`,
    "articles_Q1"                                           : `articles`,
    "articles_Q1_amb_lideratge"                             : `articles`,
    "articles_D1"                                           : `articles`,
    "articles_FWCI_10"                                      : `articles`,
    "cites_articles"                                        : `cites`,
    "impact_factor"                                         : `IF`,
    "estades_recercaires_acollits"                          : `estades`,
    "estades_recercaires_en_altres_centres"                 : `estades`,
    "rati_exit_propostes_europa"                            : `%`,
    "euros_recerca_L17_L18"                                 : `k€`,
    "articles_Q1_L17_L18"                                   : `articles`,
    "euros_projectes_KTT_respecte_total"                    : `%`,
    "euros_projectes_KTT"                                   : `k€`,
    "projectes_KTT"                                         : `projectes`,
    "formacions_per_empreses_organitzades"                  : `formacions`,
    "projectes_llavor_producte_innovadors"                  : `projectes`,
    "doctorats_industrials"                                 : `persones`,
    "euros_mecenatge"                                       : `k€`,
    "projectes_mecenatge"                                   : `projectes`,
    "patents_i_secrets_industrials"                         : `#`,
    "spinoffs_i_startups"                                   : `#`,
    "articles_amb_socis_industrials"                        : `articles`,
    "estudiants_acollits"                                   : `persones`,
    "cites_en_legislacio"                                   : `cites`,
    "participacions_comites_experts_ambit_legislatiu"       : `participacions`,
    "premis_nacionals"                                      : `premis`,
    "premis_internacionals"                                 : `premis`,
    "narratives_impacte_CERCA"                              : `narratives`,
    "contribucions_gestio_aigua"                            : `contribucions`,
    "llocs_de_treball_generats_llicencies"                  : `llocs de treball`,
    "aliances_solides_entitats_socials"                     : `aliances`,
    "xxss_seguidors"                                        : `seguidors`,
    "xxss_shares"                                           : `shares`,
    "xxss_streams"                                          : `views`,
    "actes_disseminacio_participats_o_organitzats"          : `actes`,
    "aparicions_mitjans_comunicacio_nacionals"              : `aparicions`,
    "aparicions_mitjans_comunicacio_internacionals"         : `aparicions`,
    "reunions_taula_aigua_ACA"                              : `reunions`,
    "hores_tasques_taula_aigua_ACA"                         : `hores`,
    "euros_projectes_KTT_ACA"                               : `k€`,
    "tallers_UdG_ICRA"                                      : `tallers`,
    "iniciatives_UdG_ICRA"                                  : `iniciatives`,
    "euros_projectes_KTT_UdG"                               : `k€`,
    "participacions_activitats_JEDI_organitzades_per_CERCA" : `actes`,
    "eficiencia_articles_amb_socis_industrials"             : `k€/article`,
    "objectius_assolits_del_pla_formacio"                   : `%`,
    "participants_actes_disseminacio_participats"           : `participants`,
    "projectes_competitius_outreach"                        : `projectes`,
    "euros_projectes_competitius_outreach"                  : `k€`,
    "aliances_solides_empreses_i_administracio_publica"     : `aliances`,
    "projectes_i_encarrecs_ACA"                             : `projectes`,
    "accions_suport_tecnic_a_ACA_quimica_analitica"         : `accions de suport tècnic`,
    "participants_tallers_UdG_ICRA"                         : `participants`,
    "nombre_IPs"                                            : `persones`,
    "posicions_RF_creades"                                  : `posicions`,
    "posicions_RS_estabilitzacio_RF"                        : `posicions`,
    "canvis_tram_RS_o_RP"                                   : `canvis`,
    "sessions_JEDI_formacio_interna"                        : `sessions`,
    "participants_sessions_JEDI_formacio_interna"           : `%`,
    "activitats_JEDI_organitzades"                          : `activitats`,
    "dones_categories_laborals_superiors"                   : `persones`,
    "projectes_amb_administracio_central"                   : `projectes`,
    "euros_projectes_amb_administracio_central"             : `k€`,

    "ips_euros_recerca"                                   :"k€",
    "ips_projectes_erc_eic"                               :"projectes",
    "ips_projectes_coordinats_5_socis_2M"                 :"projectes",
    "ips_projectes_coordinats_4_socis_1M"                 :"projectes",
    "ips_projectes_IP_o_COIP"                             :"projectes",
    "ips_projectes_participant"                           :"projectes",
    "ips_congressos_tallers_escoles_estiu_organitzats"    :"activitats",
    "ips_conferencies_convidades"                         :"conferències",
    "ips_comites_internacionals_participats"              :"comitès",
    "ips_articles_Q1"                                     :"articles",
    "ips_articles_D1_percentatge"                         :"%",
    "ips_articles_FWCI_10"                                :"articles",
    "ips_treball_editorial_Q1"                            :"treball",
    "ips_tesis_doctorals"                                 :"tesis doctorals",
    "ips_postdocs_supervisats"                            :"postdocs",
    "ips_estades_recercaires_acollits"                    :"estades",
    "ips_euros_projectes_KTT"                             :"k€",
    "ips_formacions_per_empreses_organitzades"            :"formacions",
    "ips_patents_i_secrets_industrials"                   :"#",
    "ips_spinoffs_i_startups"                             :"#",
    "ips_articles_amb_socis_industrials"                  :"%",
    "ips_estudiants_acollits"                             :"estudiants",
    "ips_cites_en_legislacio"                             :"cites",
    "ips_participacions_comites_experts_ambit_legislatiu" :"participacions",
    "ips_premis_nacionals_i_internacionals"               :"premis",
    "ips_narratives_impacte_CERCA"                        :"narratives",
    "ips_actes_disseminacio_participats_o_organitzats"    :"actes",
    "ips_aparicions_mitjans_comunicacio_nacionals"        :"aparicions",
    "ips_aparicions_mitjans_comunicacio_internacionals"   :"aparicions",
  };

  //taula: "id_indicador"=> function
  let funcions_calculadores={
    euros_recerca(year,indicador){
      //taula ingressos filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //projectes (no filtrar per year perquè hi pot haver gastos un cop tancat)
      let projectes = app.taules.projectes.taula;
      if(!projectes) return;

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      //diccionari codi=>projecte
      let joined={};

      //itera ingressos
      ingressos.forEach(ing=>{
        let codi = ing.Codi; //string
        let pro  = busca_projecte(codi);//objecte
        if(!pro) return;

        joined[codi]={
          projecte  : pro,
          ingressos : ing.Ingressos,
        };
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      if(indicador){
        indicador.years[year].valor  = keuros; //number
        indicador.years[year].llista = llista.map(row=>{
          let new_row={
            ingressos: row.ingressos,
          };
          app.taules.projectes.columnes_actives.forEach(key=>{
            new_row[key] = row.projecte[key];
          });
          return new_row;
        });
      }

      return keuros;
    },

    euros_recerca_horizon(year,indicador){
      //filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //filtra projectes
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="FONS COMPETITIUS"&&
          pro["Naturaleza del Proyecto"]=="EUROPEA"&&
          pro["Financiador Convocatoria"]!=null&&1
          /*
          (
            pro["Financiador Convocatoria"].toUpperCase().includes("H2020")||
            pro["Financiador Convocatoria"].toUpperCase().includes("HORIZON")
          )
          */
        );
      });

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      //ajunta taules per codi projecte
      let joined={};

      ingressos.forEach(ing=>{
        let codi     = ing.Codi;//string
        let projecte = busca_projecte(codi,projectes);
        if(!projecte) return;
        joined[codi]={
          projecte,
          ingressos: ing.Ingressos,
        }
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          ingressos: row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });
    },//OK

    euros_recerca_erc_eic(year,indicador){
      //projectes ERC/EIC vigents a l'any "year"
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="FONS COMPETITIUS"&&
          pro["Naturaleza del Proyecto"]=="EUROPEA"&&
          pro["Financiador Convocatoria"]!=null&&
          (
            pro["Financiador Convocatoria"].toUpperCase().startsWith("ERC")||
            pro["Financiador Convocatoria"].toUpperCase().startsWith("EIC")
          )
        );
      });

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      let joined={};
      ingressos.forEach(ing=>{
        let codi = ing.Codi;
        let projecte = busca_projecte(codi,projectes);//object
        if(!projecte) return;
        joined[codi]={
          projecte,
          ingressos: ing.Ingressos,
        }
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          ingressos: row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });
    },//OK

    euros_recerca_estatal(year, indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="FONS COMPETITIUS"&&
          pro["Naturaleza del Proyecto"]=="NACIONAL"
        );
      });
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //ajunta taules per codi projecte
      let joined={};
      ingressos.forEach(ing=>{
        let codi     = ing.Codi;//string
        let projecte = busca_projecte(codi,projectes);//objecte
        if(!projecte) return;
        joined[codi]={
          projecte,
          ingressos: ing.Ingressos,
        }
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          ingressos: row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });
    },

    euros_recerca_regional(year, indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="FONS COMPETITIUS"&&
          pro["Naturaleza del Proyecto"]=="REGIONAL"
        );
      });
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //ajunta taules per codi projecte
      let joined={};
      ingressos.forEach(ing=>{
        let codi     = ing.Codi;//string
        let projecte = busca_projecte(codi,projectes);//objecte
        if(!projecte) return;
        joined[codi]={
          projecte,
          ingressos: ing.Ingressos,
        }
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          ingressos: row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });
    },

    projectes_horizon(year, indicador){
      //projectes europeus coordinats
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]            == "FONS COMPETITIUS"&&
          pro["Naturaleza del Proyecto"] == "EUROPEA"&&
          pro["Iniciativa"]              == "COORDINAT / COORDINADOR"&&
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      [ //veure columnes a detalls
        "Concurrencia",
        "Naturaleza del Proyecto",
        "Iniciativa",
        "Financiador Convocatoria",
      ].forEach(col=>{
        app.taules.projectes.columnes[col]=true;
      });

      //valor final indicador
      indicador.years[year].valor  = projectes.length;
      indicador.years[year].llista = projectes.map(row=>{
        let new_row={};
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key]=row[key];
        });
        return new_row;
      });
    },

    projectes_erc_eic(year, indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="FONS COMPETITIUS"&&
          pro["Naturaleza del Proyecto"]=="EUROPEA"&&
          pro["Financiador Convocatoria"]!=null&&
          pro["Financiador Convocatoria"].includes("ERC")&&
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });
      indicador.years[year].valor  = projectes.length;
      indicador.years[year].llista = projectes.map(row=>{
        let new_row={};
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key]=row[key];
        });
        return new_row;
      });
    },

    congressos_tallers_escoles_estiu_organitzats(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("08")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    sessions_especials_organitzades(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("14")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    comites_internacionals_participats(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("06")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    //bloc scopus
    articles_Q1(year,indicador){
      let scopus = app.taules.scopus.taula.filter(row=>row.year==year);
      let n      = scopus.length ? scopus[0].articles_Q1 : 0;
      indicador.years[year].valor  = n;
      indicador.years[year].llista = scopus;
    },
    articles_Q1_amb_lideratge(year,indicador){
      let scopus = app.taules.scopus.taula.filter(row=>row.year==year);
      let n      = scopus.length ? scopus[0].articles_Q1_amb_lideratge : 0;
      indicador.years[year].valor  = n;
      indicador.years[year].llista = scopus;
    },
    articles_D1(year,indicador){
      let scopus = app.taules.scopus.taula.filter(row=>row.year==year);
      let n      = scopus.length ? scopus[0].articles_D1 : 0;
      indicador.years[year].valor  = n;
      indicador.years[year].llista = scopus;
    },
    articles_FWCI_10(year,indicador){
      let scopus = app.taules.scopus.taula.filter(row=>row.year==year);
      let n      = scopus.length ? scopus[0].articles_FWCI_10 : 0;
      indicador.years[year].valor  = n;
      indicador.years[year].llista = scopus;
    },
    cites_articles(year,indicador){
      let scopus = app.taules.scopus.taula.filter(row=>row.year==year);
      let n      = scopus.length ? scopus[0].cites_articles : 0;
      indicador.years[year].valor  = n;
      indicador.years[year].llista = scopus;
    },
    impact_factor(year,indicador){
      let scopus = app.taules.scopus.taula.filter(row=>row.year==year);
      let n      = scopus.length ? scopus[0].impact_factor : 0;
      indicador.years[year].valor  = n;
      indicador.years[year].llista = scopus;
    },
    //bloc scopus end

    estades_recercaires_acollits(year,indicador){
      let personal = app.taules.personal.taula.filter(per=>{
        return(
          (
            per["Categoria"]=="110. VISITING SCIENTIST"||
            (
              per["Categoria"]=="120. VISITING STUDENT"&&
              (
                per["Titulacio"]=="010. DOCTOR"||
                per["Titulacio"]=="020. MASTER"||
                per["Titulacio"]=="030. LLICENCIAT"||
                per["Titulacio"]=="040. DIPLOMAT"||
                per["Titulacio"]=="050. GRAU"
              )
            )
          )&&
          new Date(per["Datainicicontracte"]).getFullYear()<=year &&
          new Date(per["DataFiContracte"   ]).getFullYear()>=year
        );
      });

      app.taules.personal.columnes["Nom"]=true;
      app.taules.personal.columnes["Categoria"]=true;
      app.taules.personal.columnes["Titulacio"]=true;

      if(indicador){
        indicador.years[year].valor  = personal.length;
        indicador.years[year].llista = personal;
      }

      return personal.length;
    },

    estades_recercaires_en_altres_centres(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("10")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    rati_exit_propostes_europa(year,indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]            == "FONS COMPETITIUS" &&
          pro["Naturaleza del Proyecto"] == "EUROPEA" &&
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      let estats={};
      projectes.forEach(pro=>{
        let estat = pro["Situación del Proyecto"];
        if(estats[estat]==undefined) estats[estat]=0;
        estats[estat]++;
      });
      estats.Totals = projectes.length;

      let execucio    = estats["En Execucio"] ?? 0;
      let tancats     = estats["Tancat"]      ?? 0;
      let finalitzats = estats["Finalitzat"]  ?? 0;
      let concedits   = estats["Concedit"]    ?? 0;
      let exitosos    = execucio+tancats+finalitzats+concedits;
      let n           = projectes.length;
      let rati        = n ? 100*exitosos/n : 0;

      indicador.years[year].valor  = rati;
      indicador.years[year].llista = [estats];
    },

    euros_recerca_L17_L18(year,indicador){
      //filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //filtra projectes
      let projectes = app.taules.projectes.taula.filter(pro=>{
        try{
          return(
            pro["Unidad de Gestión"]&&(
              pro["Unidad de Gestión"].includes("L17")||
              pro["Unidad de Gestión"].includes("L18")
            )
          );
        }catch(err){
          console.log({pro})
          throw(err);
        }
      });

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;
      app.taules.projectes.columnes["Unidad de Gestión"]=true;

      //ajunta taules per codi projecte
      let joined={};

      ingressos.forEach(ing=>{
        let codi     = ing.Codi;//string
        let projecte = busca_projecte(codi,projectes);
        if(!projecte) return;
        joined[codi]={
          projecte,
          ingressos: ing.Ingressos,
        }
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      if(indicador){
        indicador.years[year].valor  = keuros; //number
        indicador.years[year].llista = llista.map(row=>{
          let new_row={
            ingressos: row.ingressos,
          };
          app.taules.projectes.columnes_actives.forEach(key=>{
            new_row[key] = row.projecte[key];
          });
          return new_row;
        });
      }

      return keuros;
    },

    articles_Q1_L17_L18(year,indicador){
      let scopus = app.taules.scopus.taula.filter(row=>row.year==year);
      let n      = scopus.length ? scopus[0].articles_Q1_L17_L18 : 0;
      indicador.years[year].valor  = n;
      indicador.years[year].llista = scopus;
    },

    euros_projectes_KTT_respecte_total(year, indicador){
      let keuros_projectes_KTT = this.euros_projectes_KTT(year);
      let keuros_recerca       = this.euros_recerca(year);

      if(keuros_recerca){
        percentatge = 100*keuros_projectes_KTT/keuros_recerca;
      }else{
        percentatge = 0;
      }

      indicador.years[year].valor = percentatge;
      indicador.years[year].llista = [
        {keuros_projectes_KTT, keuros_recerca},
      ];

      return percentatge;
    },

    euros_projectes_KTT(year, indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="TRANSFERENCIA I PRESTACIO DE SERVEIS"||
          pro["Concurrencia"]=="KTT"
        );
      });
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //ajunta taules per codi projecte
      let joined={};
      ingressos.forEach(ing=>{
        let codi     = ing.Codi;//string
        let projecte = busca_projecte(codi,projectes);//objecte
        if(!projecte) return;
        joined[codi]={
          projecte,
          ingressos: ing.Ingressos,
        }
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      if(indicador){
        indicador.years[year].valor  = keuros; //number
        indicador.years[year].llista = llista.map(row=>{
          let new_row={
            ingressos: row.ingressos,
          };
          app.taules.projectes.columnes_actives.forEach(key=>{
            new_row[key] = row.projecte[key];
          });
          return new_row;
        });
      }

      return keuros;
    },

    projectes_KTT(year, indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Tipo de Financiación Contracte Programa"]=="TRANSFERENCIA"&&
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      [
        "Concurrencia",
        "Naturaleza del Proyecto",
        "Financiador Convocatoria",
        "Director del Proyecto",
        "Tipo de Financiación Contracte Programa",
      ].forEach(col=>{
        app.taules.projectes.columnes[col]=true;
      });

      let n_projectes = projectes.length;
      indicador.years[year].valor  = n_projectes; //number
      indicador.years[year].llista = projectes.map(pro=>{
        let new_row={};
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = pro[key];
        });
        return new_row;
      });

      return n_projectes;
    },

    formacions_per_empreses_organitzades(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("11")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    projectes_llavor_producte_innovadors(year,indicador){
      let projectes = app.taules.projectes.taula.filter(row=>{
        let nom = row["Título Abreviado"].toUpperCase();
        return(
          (
            nom.startsWith("LLAVOR")||
            nom.startsWith("PRODUCTE")||
            nom.startsWith("INNOVADORS")||
            nom.startsWith("EIC")
          )&&
          (
            row["Situación del Proyecto"]=="En Execucio"||
            row["Situación del Proyecto"]=="Finalitzat"||
            row["Situación del Proyecto"]=="Tancat"
          )&&
          new Date(row["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(row["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      [
        "Concurrencia",
        "Naturaleza del Proyecto",
        "Financiador Convocatoria",
        "Director del Proyecto",
        "Tipo de Financiación Contracte Programa",
      ].forEach(col=>{
        app.taules.projectes.columnes[col]=true;
      });

      let n_projectes = projectes.length;

      indicador.years[year].valor  = n_projectes; //number
      indicador.years[year].llista = projectes.map(row=>{
        let new_row={};
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row[key];
        });
        return new_row;
      });

      return n_projectes;
    },

    doctorats_industrials(year,indicador){
      let personal = app.taules.personal.taula.filter(per=>{
        return(
          per["Categoria"]=="126. DOCTORAT INDUSTRIAL"&&
          new Date(per["Datainicicontracte"]).getFullYear()<=year &&
          new Date(per["DataFiContracte"   ]).getFullYear()>=year
        );
      });

      app.taules.personal.columnes["Nom"]=true;
      app.taules.personal.columnes["Categoria"]=true;
      app.taules.personal.columnes["Titulacio"]=true;

      if(indicador){
        indicador.years[year].valor  = personal.length;
        indicador.years[year].llista = personal;
      }

      return personal.length;
    },

    euros_mecenatge(year,indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="MECENATGE"
        );
      });
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //ajunta taules per codi projecte
      let joined={};
      ingressos.forEach(ing=>{
        let codi     = ing.Codi;//string
        let projecte = busca_projecte(codi,projectes);//objecte
        if(!projecte) return;
        joined[codi]={
          projecte,
          ingressos: ing.Ingressos,
        }
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      if(indicador){
        indicador.years[year].valor  = keuros; //number
        indicador.years[year].llista = llista.map(row=>{
          let new_row={
            ingressos: row.ingressos,
          };
          app.taules.projectes.columnes_actives.forEach(key=>{
            new_row[key] = row.projecte[key];
          });
          return new_row;
        });
      }

      return keuros;
    },

    projectes_mecenatge(year,indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="MECENATGE"&&
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      let llista      = projectes;     //array
      let n_projectes = llista.length; //number

      indicador.years[year].valor  = n_projectes; //number
      indicador.years[year].llista = llista; //array
    },

    patents_i_secrets_industrials(year,indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Título Abreviado"].toUpperCase().startsWith("PATENT")&&
          pro["Situación del Proyecto"]!="Descartat"&&
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      let llista      = projectes;     //array
      let n_projectes = llista.length; //number

      indicador.years[year].valor  = n_projectes; //number
      indicador.years[year].llista = llista; //array
    },

    spinoffs_i_startups(year,indicador){
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Título Abreviado"].replaceAll("-","").toUpperCase().startsWith("SPINOFF")&&
          pro["Situación del Proyecto"]!="Descartat"&&
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      let llista      = projectes;     //array
      let n_projectes = llista.length; //number

      indicador.years[year].valor  = n_projectes; //number
      indicador.years[year].llista = llista; //array
    },

    articles_amb_socis_industrials(year,indicador){
      let scopus = app.taules.scopus.taula.filter(row=>row.year==year);
      let n      = scopus.length ? scopus[0].articles_amb_socis_industrials : 0;
      indicador.years[year].valor  = n;
      indicador.years[year].llista = scopus;
    },

    estudiants_acollits(year,indicador){
      let personal = app.taules.personal.taula.filter(per=>{
        return(
          per["Categoria"]=="120. VISITING STUDENT"&&
          (
            per["Titulacio"]=="070. BATXILLERAT"||
            per["Titulacio"]=="085. ESO"
          )&&
          new Date(per["Datainicicontracte"]).getFullYear()<=year &&
          new Date(per["DataFiContracte"   ]).getFullYear()>=year
        );
      });

      app.taules.personal.columnes["Nom"]=true;
      app.taules.personal.columnes["Categoria"]=true;
      app.taules.personal.columnes["Titulacio"]=true;

      if(indicador){
        indicador.years[year].valor  = personal.length;
        indicador.years[year].llista = personal;
      }

      return personal.length;
    },

    cites_en_legislacio(year,indicador){
      let scopus = app.taules.scopus.taula.filter(row=>row.year==year);
      let n      = scopus.length ? scopus[0].cites_en_legislacio : 0;
      indicador.years[year].valor  = n;
      indicador.years[year].llista = scopus;
    },

    participacions_comites_experts_ambit_legislatiu(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("05")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    premis_nacionals(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("13")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    premis_internacionals(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("12")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    narratives_impacte_CERCA(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("17")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    contribucions_gestio_aigua(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("18")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    llocs_de_treball_generats_llicencies(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("19")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    aliances_solides_entitats_socials(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("20")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    xxss_seguidors(year,indicador){
      let xarxes = app.taules.xarxes_socials.taula.find(row=>{
        return row["any"]==year;
      });
      if(!xarxes) return;

      indicador.years[year].valor  = xarxes["seguidors"];
      indicador.years[year].llista = [xarxes];
    },

    xxss_shares(year,indicador){
      let xarxes = app.taules.xarxes_socials.taula.find(row=>{
        return row["any"]==year;
      });
      if(!xarxes) return;

      indicador.years[year].valor  = xarxes["shares"];
      indicador.years[year].llista = [xarxes];
    },

    xxss_streams(year,indicador){
      let xarxes = app.taules.xarxes_socials.taula.find(row=>{
        return row["any"]==year;
      });
      if(!xarxes) return;

      indicador.years[year].valor  = xarxes["streams"];
      indicador.years[year].llista = [xarxes];
    },

    actes_disseminacio_participats_o_organitzats(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("01")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    aparicions_mitjans_comunicacio_nacionals(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("04")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    aparicions_mitjans_comunicacio_internacionals(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("03")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    reunions_taula_aigua_ACA:null, //TODO

    hores_tasques_taula_aigua_ACA(year,indicador){
      let taula_aigua = app.taules.taula_aigua.taula.filter(row=>{
        return new Date(row["DataAlta"]).getFullYear()==year;
      });

      app.taules.taula_aigua.columnes["Nom"]=true;
      app.taules.taula_aigua.columnes["Horas"]=true;
      app.taules.taula_aigua.columnes["Descripcio"]=true;

      let hores = taula_aigua.map(r=>r.Horas).suma();

      if(indicador){
        indicador.years[year].valor  = hores;
        indicador.years[year].llista = taula_aigua;
      }

      return hores;
    },

    euros_projectes_KTT_ACA(year,indicador){
      //"Aportacions de projectes o contractes de KTT amb l'ACA, via contracte programa o licitació"

      //diccionari codi=>projecte
      //3 taules: stakeholders, ingressos, projectes
      let joined={};

      let stakeholders = app.taules.stakeholders.taula
        .filter(s=>
          s["Tercero Id"]=="31"||
          s["Tercero"]=="Agència Catalana de l'Aigua"
        );

      //taula ingressos filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //projectes (no filtrar per year perquè hi pot haver gastos un cop tancat)
      let projectes = app.taules.projectes.taula;

      stakeholders.forEach(sth=>{
        let codi = sth["Proyecto Código Identificativo"];
        let ing  = busca_projecte(codi,ingressos,"Codi");
        if(!ing) return;
        let pro  = busca_projecte(codi);
        if(!pro) return;
        joined[codi]={
          stakeholder: sth["Tercero"],
          projecte   : pro,
          ingressos  : ing.Ingressos,
        };
      });

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          stakeholder: row.stakeholder,
          ingressos:   row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });

      return keuros;
    },

    tallers_UdG_ICRA(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("15")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    iniciatives_UdG_ICRA(year,indicador){
      //ajunta taules: stakeholders, projectes
      let joined={};

      let stakeholders = app.taules.stakeholders.taula
        .filter(s=>
          s["Tercero Id"]=="22"||
          s["Tercero"]=="Universitat de Girona"
        );

      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      stakeholders.forEach(sth=>{
        let codi = sth["Proyecto Código Identificativo"];
        let pro  = busca_projecte(codi);
        if(!pro) return;
        joined[codi]={
          stakeholder: sth["Tercero"],
          projecte   : pro,
        };
      });

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      let llista      = Object.values(joined); //array
      let n_projectes = llista.length; //number

      indicador.years[year].valor  = n_projectes; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          stakeholder: row.stakeholder,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });

      return n_projectes;
    },

    euros_projectes_KTT_UdG(year,indicador){
      //diccionari codi=>projecte
      //3 taules: stakeholders, ingressos, projectes
      let joined={};

      let stakeholders = app.taules.stakeholders.taula
        .filter(s=>
          s["Tercero Id"]=="22"||
          s["Tercero"]=="Universitat de Girona"
        );

      //taula ingressos filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //projectes (no filtrar per year perquè hi pot haver gastos un cop tancat)
      let projectes = app.taules.projectes.taula;

      stakeholders.forEach(sth=>{
        let codi = sth["Proyecto Código Identificativo"];
        let ing  = busca_projecte(codi,ingressos,"Codi");
        if(!ing) return;
        let pro  = busca_projecte(codi);
        if(!pro) return;
        joined[codi]={
          stakeholder: sth["Tercero"],
          projecte   : pro,
          ingressos  : ing.Ingressos,
        };
      });

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          stakeholder: row.stakeholder,
          ingressos:   row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });

      return keuros;
    },

    participacions_activitats_JEDI_organitzades_per_CERCA(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("02")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    eficiencia_articles_amb_socis_industrials:null,

    objectius_assolits_del_pla_formacio:null,

    participants_actes_disseminacio_participats:null,

    projectes_competitius_outreach:null, //esperar ordi TODO

    euros_projectes_competitius_outreach:null, //esperar ordi TODO

    aliances_solides_empreses_i_administracio_publica(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("21")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    projectes_i_encarrecs_ACA:null,

    accions_suport_tecnic_a_ACA_quimica_analitica:null,

    participants_tallers_UdG_ICRA(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("15")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_participants = esdeveniments.map(e=>e.Participants).suma();

      if(indicador){
        indicador.years[year].valor  = n_participants;
        indicador.years[year].llista = esdeveniments;
      }

      return n_participants;
    },

    nombre_IPs:null, //preguntar ruben

    posicions_RF_creades:null,

    posicions_RS_estabilitzacio_RF:null,

    canvis_tram_RS_o_RP:null,

    sessions_JEDI_formacio_interna(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("22")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    participants_sessions_JEDI_formacio_interna(year,indicador){
      let esdeveniments = app.taules.esdeveniments.taula.filter(esd=>{
        return(
          esd["Tipus_Esdeveniment"].startsWith("22")&&
          new Date(esd["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(esd["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_participants = esdeveniments.map(e=>e.Participants).suma();

      if(indicador){
        indicador.years[year].valor  = n_participants;
        indicador.years[year].llista = esdeveniments;
      }

      return n_participants;
    },

    activitats_JEDI_organitzades:null, //TODO no hi ha tipus esdeveniment

    dones_categories_laborals_superiors:null,

    projectes_amb_administracio_central(year,indicador){
      //diccionari codi=>projecte
      let joined={};

      let stakeholders = app.taules.stakeholders.taula
        .filter(s=>
          s["Tercero Id"]=="9"||
          s["Tercero"]=="Agencia Estatal de Investigación"
        );

      //projectes filtrats per any
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      stakeholders.forEach(sth=>{
        let codi = sth["Proyecto Código Identificativo"];
        let pro  = busca_projecte(codi,projectes);
        if(!pro) return;
        joined[codi]={
          stakeholder: sth["Tercero"],
          projecte   : pro,
        };
      });

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      let llista = Object.values(joined); //array
      let n_projectes = llista.length;

      indicador.years[year].valor  = llista.length; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          stakeholder: row.stakeholder,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });

      return n_projectes;
    },

    euros_projectes_amb_administracio_central(year,indicador){
      //diccionari codi=>projecte
      //3 taules: stakeholders, ingressos, projectes
      let joined={};

      let stakeholders = app.taules.stakeholders.taula
        .filter(s=>
          s["Tercero Id"]=="9"||
          s["Tercero"]=="Agencia Estatal de Investigación"
        );

      //taula ingressos filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      //projectes (no filtrar per year perquè hi pot haver gastos un cop tancat)
      let projectes = app.taules.projectes.taula;

      stakeholders.forEach(sth=>{
        let codi = sth["Proyecto Código Identificativo"];
        let ing  = busca_projecte(codi,ingressos,"Codi");
        if(!ing) return;
        let pro  = busca_projecte(codi);
        if(!pro) return;
        joined[codi]={
          stakeholder: sth["Tercero"],
          projecte   : pro,
          ingressos  : ing.Ingressos,
        };
      });

      app.taules.projectes.columnes["Concurrencia"]=true;
      app.taules.projectes.columnes["Naturaleza del Proyecto"]=true;
      app.taules.projectes.columnes["Financiador Convocatoria"]=true;
      app.taules.projectes.columnes["Director del Proyecto"]=true;

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      indicador.years[year].valor  = keuros; //number
      indicador.years[year].llista = llista.map(row=>{
        let new_row={
          stakeholder: row.stakeholder,
          ingressos:   row.ingressos,
        };
        app.taules.projectes.columnes_actives.forEach(key=>{
          new_row[key] = row.projecte[key];
        });
        return new_row;
      });

      return keuros;
    },

    ips_euros_recerca(year, indicador){
      year = year   || "2023";

      let nom_ip = app.ip_seleccionat?.nom || "Acuña Salazar, Vicenç";

      //taula ingressos filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);
      let personal  = app.taules.projectes_personal.taula.filter(row=>{
        return(
          row["Persona"]==nom_ip &&(
            row["EnQualitatde"]=="INVESTIGADOR/A PRINCIPAL (IP)"||
            row["EnQualitatde"]=="CO IP"
          )&&(
            row["Tipo de Financiación Contracte Programa"]=="RECERCA"||
            row["Tipo de Financiación Contracte Programa"]=="TRANSFERENCIA"
          )&&(
            new Date(row["DataInici"]).getFullYear()<=year &&
            new Date(row["DataFi"   ]).getFullYear()>=year
          )
        );
      });

      //diccionari codi=>projecte
      let joined={};

      //itera ingressos
      personal.forEach(row=>{
        let codi = row.CodiProjecte; //string

        let ing  = busca_projecte(codi,ingressos,"Codi");
        if(!ing) return;

        let pro  = busca_projecte(codi);//objecte
        if(!pro) return;

        joined[codi]={
          Persona      : nom_ip,
          EnQualitatde : row.EnQualitatde,
          projecte     : pro,
          ingressos    : ing.Ingressos,
        };
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      app.taules.projectes.columnes["Tipo de Financiación Contracte Programa"]=true;

      if(indicador){
        indicador.years[year].valor  = keuros; //number
        indicador.years[year].llista = llista.map(row=>{
          let new_row={
            Persona:       row.Persona,
            EnQualitatde : row.EnQualitatde,
            ingressos:     row.ingressos,
          };
          app.taules.projectes.columnes_actives.forEach(key=>{
            new_row[key] = row.projecte[key];
          });
          return new_row;
        });
      }

      return keuros;
    },

    ips_euros_projectes_KTT(year,indicador){
      year = year || "2023";

      let nom_ip = app.ip_seleccionat?.nom || "Acuña Salazar, Vicenç";

      //taula ingressos filtra per year
      let ingressos = app.taules.ingressos.taula.filter(i=>i.Any==year);

      let personal = app.taules.projectes_personal.taula.filter(row=>{
        return(
          row["Persona"]==nom_ip &&(
            row["EnQualitatde"]=="INVESTIGADOR/A PRINCIPAL (IP)"||
            row["EnQualitatde"]=="CO IP"
          )&&(
            row["Tipo de Financiación Contracte Programa"]=="TRANSFERENCIA"
          )&&(
            new Date(row["DataInici"]).getFullYear()<=year &&
            new Date(row["DataFi"   ]).getFullYear()>=year
          )
        );
      });

      //diccionari codi=>projecte
      let joined={};

      personal.forEach(row=>{
        let codi = row.CodiProjecte; //string

        let ing  = busca_projecte(codi,ingressos,"Codi");
        if(!ing) return;

        let pro  = busca_projecte(codi);
        if(!pro) return;

        joined[codi]={
          Persona      : nom_ip,
          EnQualitatde : row.EnQualitatde,
          projecte     : pro,
          ingressos    : ing.Ingressos,
        };
      });

      let llista = Object.values(joined); //array
      let keuros = llista.map(obj=>obj.ingressos).suma()/1000; //number

      app.taules.projectes.columnes["Tipo de Financiación Contracte Programa"]=true;

      if(indicador){
        indicador.years[year].valor  = keuros; //number
        indicador.years[year].llista = llista.map(row=>{
          let new_row={
            Persona:   row.Persona,
            ingressos: row.ingressos,
          };
          app.taules.projectes.columnes_actives.forEach(key=>{
            new_row[key] = row.projecte[key];
          });
          return new_row;
        });
      }

      return keuros;
    },

    ips_projectes_erc_eic(year,indicador){
      let nom_ip = app.ip_seleccionat?.nom || "Acuña Salazar, Vicenç";
      let projectes = app.taules.projectes.taula.filter(pro=>{
        return(
          pro["Concurrencia"]=="FONS COMPETITIUS"&&
          pro["Naturaleza del Proyecto"]=="EUROPEA"&&
          pro["Financiador Convocatoria"]!=null&&
          pro["Financiador Convocatoria"].includes("ERC")&&
          new Date(pro["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(pro["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      let personal = app.taules.projectes_personal.taula.filter(row=>{
        return(
          row["Persona"]==nom_ip &&(
            row["EnQualitatde"]=="INVESTIGADOR/A PRINCIPAL (IP)"||
            row["EnQualitatde"]=="CO IP"
          )&&(
            new Date(row["DataInici"]).getFullYear()<=year &&
            new Date(row["DataFi"   ]).getFullYear()>=year
          )
        );
      });

      //diccionari codi=>projecte
      let joined={};

      personal.forEach(row=>{
        let codi = row.CodiProjecte; //string

        let pro  = busca_projecte(codi,projectes);
        if(!pro) return;

        joined[codi]={
          Persona      : nom_ip,
          EnQualitatde : row.EnQualitatde,
          projecte     : pro,
        };
      });

      let llista      = Object.values(joined); //array
      let n_projectes = llista.length;

      [ //veure columnes a detalls
        "Concurrencia",
        "Naturaleza del Proyecto",
        "Iniciativa",
        "Financiador Convocatoria",
      ].forEach(col=>{
        app.taules.projectes.columnes[col]=true;
      });

      if(indicador){
        indicador.years[year].valor  = n_projectes;
        indicador.years[year].llista = llista.map(row=>{
          let new_row={
            Persona      : row.Persona,
            EnQualitatde : row.EnQualitatde,
          };
          app.taules.projectes.columnes_actives.forEach(key=>{
            new_row[key]=row.projecte[key];
          });
          return new_row;
        });
      }
    },

    ips_projectes_IP_o_COIP(year,indicador){
      let nom_ip = app.ip_seleccionat?.nom || "Acuña Salazar, Vicenç";
      let projectes = app.taules.projectes.taula.filter(row=>{
        return(
          row["Concurrencia"]=="FONS COMPETITIUS"&&(
            row["Situación del Proyecto"]=="En Execucio"||
            row["Situación del Proyecto"]=="Finalitzat"||
            row["Situación del Proyecto"]=="Tancat"
          )&&
          new Date(row["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(row["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      let personal = app.taules.projectes_personal.taula.filter(row=>{
        return(
          row["Persona"]==nom_ip &&(
            row["EnQualitatde"]=="INVESTIGADOR/A PRINCIPAL (IP)"||
            row["EnQualitatde"]=="CO IP"
          )&&(
            new Date(row["DataInici"]).getFullYear()<=year &&
            new Date(row["DataFi"   ]).getFullYear()>=year
          )
        );
      });

      //diccionari codi=>projecte
      let joined={};

      personal.forEach(row=>{
        let codi = row.CodiProjecte; //string

        let pro  = busca_projecte(codi,projectes);
        if(!pro) return;

        joined[codi]={
          Persona      : nom_ip,
          EnQualitatde : row.EnQualitatde,
          projecte     : pro,
        };
      });

      let llista      = Object.values(joined); //array
      let n_projectes = llista.length;

      [ //veure columnes a detalls
        "Concurrencia",
        "Naturaleza del Proyecto",
        "Iniciativa",
        "Financiador Convocatoria",
      ].forEach(col=>{
        app.taules.projectes.columnes[col]=true;
      });

      if(indicador){
        indicador.years[year].valor  = n_projectes;
        indicador.years[year].llista = llista.map(row=>{
          let new_row={
            Persona      : row.Persona,
            EnQualitatde : row.EnQualitatde,
          };
          app.taules.projectes.columnes_actives.forEach(key=>{
            new_row[key]=row.projecte[key];
          });
          return new_row;
        });
      }
    },

    ips_projectes_participant(year,indicador){
      let nom_ip = app.ip_seleccionat?.nom || "Acuña Salazar, Vicenç";
      let projectes = app.taules.projectes.taula.filter(row=>{
        return(
          row["Concurrencia"]=="FONS COMPETITIUS"&&(
            row["Situación del Proyecto"]=="En Execucio"||
            row["Situación del Proyecto"]=="Finalitzat"||
            row["Situación del Proyecto"]=="Tancat"
          )&&
          new Date(row["Fecha Comienzo"]).getFullYear()<=year&&
          new Date(row["Fecha Fin Real"]).getFullYear()>=year
        );
      });

      let personal = app.taules.projectes_personal.taula.filter(row=>{
        return(
          row["Persona"]==nom_ip &&(
            row["EnQualitatde"]!="INVESTIGADOR/A PRINCIPAL (IP)"&&
            row["EnQualitatde"]!="CO IP"
          )&&(
            new Date(row["DataInici"]).getFullYear()<=year &&
            new Date(row["DataFi"   ]).getFullYear()>=year
          )
        );
      });

      //diccionari codi=>projecte
      let joined={};

      personal.forEach(row=>{
        let codi = row.CodiProjecte; //string

        let pro  = busca_projecte(codi,projectes);
        if(!pro) return;

        joined[codi]={
          Persona      : nom_ip,
          EnQualitatde : row.EnQualitatde,
          projecte     : pro,
        };
      });

      let llista      = Object.values(joined); //array
      let n_projectes = llista.length;

      [ //veure columnes a detalls
        "Concurrencia",
        "Naturaleza del Proyecto",
        "Iniciativa",
        "Financiador Convocatoria",
      ].forEach(col=>{
        app.taules.projectes.columnes[col]=true;
      });

      if(indicador){
        indicador.years[year].valor  = n_projectes;
        indicador.years[year].llista = llista.map(row=>{
          let new_row={
            Persona      : row.Persona,
            EnQualitatde : row.EnQualitatde,
          };
          app.taules.projectes.columnes_actives.forEach(key=>{
            new_row[key]=row.projecte[key];
          });
          return new_row;
        });
      }
    },

    ips_patents_i_secrets_industrials(year,indicador){
      let nom_ip = app.ip_seleccionat?.nom || "Acuña Salazar, Vicenç";
      let personal = app.taules.projectes_personal.taula.filter(row=>{
        return(
          row["Persona"]==nom_ip &&
          row["Projecte"].toUpperCase().startsWith("PATENT")&&
          row["Situación del Proyecto"]!="Descartat"&&
          (
            new Date(row["DataInici"]).getFullYear()<=year &&
            new Date(row["DataFi"   ]).getFullYear()>=year
          )
        );
      });

      let llista      = personal;      //array
      let n_projectes = llista.length; //number

      indicador.years[year].valor  = n_projectes; //number
      indicador.years[year].llista = llista; //array
    },

    ips_spinoffs_i_startups(year,indicador){
      let nom_ip = app.ip_seleccionat?.nom || "Acuña Salazar, Vicenç";
      let personal = app.taules.projectes_personal.taula.filter(row=>{
        return(
          row["Persona"]==nom_ip &&
          row["Projecte"].replaceAll("-","").toUpperCase().startsWith("SPINOFF")&&
          row["Situación del Proyecto"]!="Descartat"&&
          (
            new Date(row["DataInici"]).getFullYear()<=year &&
            new Date(row["DataFi"   ]).getFullYear()>=year
          )
        );
      });

      let llista      = personal;      //array
      let n_projectes = llista.length; //number

      indicador.years[year].valor  = n_projectes; //number
      indicador.years[year].llista = llista; //array
    },

    ips_postdocs_supervisats(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let personal = app.taules.personal.taula.filter(row=>{
        let responsable = tr(row["Responsable"]);

        //check duració postdoc >6 mesos (180dies)
        let sis_mesos_ms = 180*24*3600*1000; //ms
        let data_inici   = new Date(row.Datainicicontracte);
        let data_final   = new Date(row.DataFiContracte);
        let duracio_ms   = data_final.getTime() - data_inici.getTime();

        return (
          responsable==nom_ip                 &&
          row["Categoria"]                    &&
          row["Categoria"].includes("POSTDOC")&&
          data_inici.getFullYear()<=year      &&
          data_final.getFullYear()>=year      &&
          duracio_ms>=sis_mesos_ms
        );
      });

      indicador.years[year].valor  = personal.length; //number
      indicador.years[year].llista = personal;        //array
    },

    ips_congressos_tallers_escoles_estiu_organitzats(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("08")                  &&
          tr(row["Persona"])==nom_ip                                  &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_conferencies_convidades(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("07")                  &&
          tr(row["Persona"])==nom_ip                                  &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_comites_internacionals_participats(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("06")                  &&
          tr(row["Persona"])==nom_ip                                  &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_treball_editorial_Q1(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("16")                  &&
          tr(row["Persona"])==nom_ip                                  &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_narratives_impacte_CERCA(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("17")                  &&
          tr(row["Persona"])==nom_ip                                  &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_formacions_per_empreses_organitzades(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("11")                  &&
          tr(row["Persona"])==nom_ip                                  &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_participacions_comites_experts_ambit_legislatiu(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("05")                  &&
          tr(row["Persona"])==nom_ip                                  &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_premis_nacionals_i_internacionals(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          (
            row["Tipus_Esdeveniment"].startsWith("12")||
            row["Tipus_Esdeveniment"].startsWith("13")
          )&&
          tr(row["Persona"])==nom_ip &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_actes_disseminacio_participats_o_organitzats(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("01") &&
          tr(row["Persona"])==nom_ip &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_aparicions_mitjans_comunicacio_nacionals(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("04") &&
          tr(row["Persona"])==nom_ip &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_aparicions_mitjans_comunicacio_internacionals(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let esdeveniments = app.taules.esdeveniments.taula.filter(row=>{
        return(
          row["Tipus_Esdeveniment"].startsWith("03") &&
          tr(row["Persona"])==nom_ip &&
          new Date(row["DataInici_Esdeveniment"]).getFullYear()<=year &&
          new Date(row["DataFi_Esdeveniment"   ]).getFullYear()>=year
        );
      });

      let n_actes = new Set(esdeveniments.map(e=>e["ID_Esdeveniment"])).size;

      if(indicador){
        indicador.years[year].valor  = n_actes;
        indicador.years[year].llista = esdeveniments;
      }

      return n_actes;
    },

    ips_estades_recercaires_acollits(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let personal = app.taules.personal.taula.filter(row=>{
        let responsable = tr(row["Responsable"]);

        //check duració postdoc >3 mesos (90dies)
        let tres_mesos_ms = 90*24*3600*1000; //ms
        let data_inici    = new Date(row.Datainicicontracte);
        let data_final    = new Date(row.DataFiContracte);
        let duracio_ms    = data_final.getTime() - data_inici.getTime();

        return(
          responsable==nom_ip && (
            row["Categoria"]=="110. VISITING SCIENTIST"|| (
              row["Categoria"]=="120. VISITING STUDENT"&& (
                row["Titulacio"]=="010. DOCTOR"||
                row["Titulacio"]=="020. MASTER"||
                row["Titulacio"]=="030. LLICENCIAT"||
                row["Titulacio"]=="040. DIPLOMAT"||
                row["Titulacio"]=="050. GRAU"
              )
            )
          ) &&
          data_inici.getFullYear()<=year &&
          data_final.getFullYear()>=year &&
          duracio_ms>=tres_mesos_ms
        );
      });

      if(indicador){
        indicador.years[year].valor  = personal.length;
        indicador.years[year].llista = personal;
      }

      return personal.length;
    },

    ips_cites_en_legislacio(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip);

      let sage = app.taules.sage.taula.find(row=>{
        return tr(row.nom)==nom_ip;
      }); //object or null

      if(!sage) return
      if(!sage.response_rebuda) return;

      let cites = sage.cites[year]||0; //number

      if(indicador){
        indicador.years[year].valor  = cites;
        indicador.years[year].llista = [{nom_ip,year,cites}];
      }

      return cites;
    },

    ips_estudiants_acollits(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents;//function
      nom_ip = tr(nom_ip); //"acunasalazarvicenc";

      let personal = app.taules.personal.taula.filter(row=>{
        let responsable = tr(row["Responsable"]);

        return(
          responsable==nom_ip &&
          row["Categoria"]=="120. VISITING STUDENT"&&
          (
            row["Titulacio"]=="070. BATXILLERAT"||
            row["Titulacio"]=="085. ESO"
          )&&
          new Date(row["Datainicicontracte"]).getFullYear()<=year &&
          new Date(row["DataFiContracte"   ]).getFullYear()>=year
        );
      });

      if(indicador){
        indicador.years[year].valor  = personal.length;
        indicador.years[year].llista = personal;
      }

      return personal.length;
    },

    ips_tesis_doctorals(year,indicador){
      let nom_ip=app.ip_seleccionat?.nom||"Acuña Salazar, Vicenç";

      let tr = app.treu_accents; //function
      nom_ip = tr(nom_ip);       //"acunasalazarvicenc";

      let tesis = app.taules.tesis.taula.filter(row=>{
        return(
          (
            tr(row["Director Tesi 1"])==nom_ip ||
            tr(row["Director tesi 2"])==nom_ip ||
            tr(row["Director tesi 3"])==nom_ip
          ) &&
          new Date(row["Data"]).getFullYear()==year
        );
      });

      if(indicador){
        indicador.years[year].valor  = tesis.length;
        indicador.years[year].llista = tesis;
      }

      return tesis.length;
    },
  };

  let funcions_calculadores_ips={
    //ordi ips_projectes_coordinats_5_socis_2M(year,indicador){}, //TODO pendent resposta jaume
    //ordi ips_projectes_coordinats_4_socis_1M(year,indicador){}, //TODO pendent resposta jaume

    //scop ips_articles_Q1(year,indicador){},                    //TODO pendent (possible)
    //scop ips_articles_D1_percentatge(year,indicador){},        //TODO pendent (possible)
    //scop ips_articles_FWCI_10(year,indicador){},               //TODO pendent accés scopus api
    //scop ips_articles_amb_socis_industrials(year,indicador){}, //TODO no se

  };

  let responsables={
    "euros_recerca"                                         : `ecofin`,
    "euros_recerca_horizon"                                 : `ecofin`,
    "euros_recerca_erc_eic"                                 : `ecofin`,
    "euros_recerca_estatal"                                 : `ecofin`,
    "euros_recerca_regional"                                : `ecofin`,
    "projectes_horizon"                                     : `ordi`,
    "projectes_erc_eic"                                     : `ordi`,
    "congressos_tallers_escoles_estiu_organitzats"          : `esdeveniments`,
    "sessions_especials_organitzades"                       : `esdeveniments`,
    "comites_internacionals_participats"                    : `esdeveniments`,
    "articles_Q1"                                           : `scopus`,
    "articles_Q1_amb_lideratge"                             : `scopus`,
    "articles_D1"                                           : `scopus`,
    "articles_FWCI_10"                                      : `scopus`,
    "cites_articles"                                        : `scopus`,
    "impact_factor"                                         : `scopus`,
    "estades_recercaires_acollits"                          : `RRHH`,
    "estades_recercaires_en_altres_centres"                 : `esdeveniments`,
    "rati_exit_propostes_europa"                            : `ordi`,
    "euros_recerca_L17_L18"                                 : `ecofin`,
    "articles_Q1_L17_L18"                                   : `scopus`,
    "euros_projectes_KTT_respecte_total"                    : `ecofin`,
    "euros_projectes_KTT"                                   : `ecofin`,
    "projectes_KTT"                                         : `ordi`,
    "formacions_per_empreses_organitzades"                  : `esdeveniments`,
    "projectes_llavor_producte_innovadors"                  : `ordi`,
    "doctorats_industrials"                                 : `RRHH`,
    "euros_mecenatge"                                       : `ecofin`,
    "projectes_mecenatge"                                   : `ordi`,
    "patents_i_secrets_industrials"                         : `ordi`,
    "spinoffs_i_startups"                                   : `ordi`,
    "articles_amb_socis_industrials"                        : `scopus`,
    "estudiants_acollits"                                   : `RRHH`,
    "cites_en_legislacio"                                   : `scopus`,
    "participacions_comites_experts_ambit_legislatiu"       : `esdeveniments`,
    "premis_nacionals"                                      : `esdeveniments`,
    "premis_internacionals"                                 : `esdeveniments`,
    "narratives_impacte_CERCA"                              : `esdeveniments`,
    "contribucions_gestio_aigua"                            : `esdeveniments`,
    "llocs_de_treball_generats_llicencies"                  : `esdeveniments`,
    "aliances_solides_entitats_socials"                     : `esdeveniments`,
    "xxss_seguidors"                                        : `comunicacio`,
    "xxss_shares"                                           : `comunicacio`,
    "xxss_streams"                                          : `comunicacio`,
    "actes_disseminacio_participats_o_organitzats"          : `esdeveniments`,
    "aparicions_mitjans_comunicacio_nacionals"              : `esdeveniments`,
    "aparicions_mitjans_comunicacio_internacionals"         : `esdeveniments`,
    "reunions_taula_aigua_ACA"                              : `esdeveniments`,
    "hores_tasques_taula_aigua_ACA"                         : `MWR`,
    "euros_projectes_KTT_ACA"                               : `ecofin`,
    "tallers_UdG_ICRA"                                      : `esdeveniments`,
    "iniciatives_UdG_ICRA"                                  : `ordi`,
    "euros_projectes_KTT_UdG"                               : `ecofin`,
    "participacions_activitats_JEDI_organitzades_per_CERCA" : `esdeveniments`,
    "eficiencia_articles_amb_socis_industrials"             : `ecofin`,
    "objectius_assolits_del_pla_formacio"                   : `preguntar_vicenç`,
    "participants_actes_disseminacio_participats"           : `esdeveniments`,
    "projectes_competitius_outreach"                        : `ordi`,
    "euros_projectes_competitius_outreach"                  : `ecofin`,
    "aliances_solides_empreses_i_administracio_publica"     : `esdeveniments`,
    "projectes_i_encarrecs_ACA"                             : `ordi`,
    "accions_suport_tecnic_a_ACA_quimica_analitica"         : `preguntar_vicenç`,
    "participants_tallers_UdG_ICRA"                         : `esdeveniments`,
    "nombre_IPs"                                            : `RRHH`,
    "posicions_RF_creades"                                  : `RRHH`,
    "posicions_RS_estabilitzacio_RF"                        : `RRHH`,
    "canvis_tram_RS_o_RP"                                   : `RRHH`,
    "sessions_JEDI_formacio_interna"                        : `esdeveniments`,
    "participants_sessions_JEDI_formacio_interna"           : `esdeveniments`,
    "activitats_JEDI_organitzades"                          : `esdeveniments`,
    "dones_categories_laborals_superiors"                   : `RRHH`,
    "projectes_amb_administracio_central"                   : `ordi`,
    "euros_projectes_amb_administracio_central"             : `ecofin`,

    "ips_euros_recerca"                                   :"ecofin",
    "ips_projectes_erc_eic"                               :"ordi",
    "ips_projectes_coordinats_5_socis_2M"                 :"ordi",
    "ips_projectes_coordinats_4_socis_1M"                 :"ordi",
    "ips_projectes_IP_o_COIP"                             :"ordi",
    "ips_projectes_participant"                           :"ordi",
    "ips_congressos_tallers_escoles_estiu_organitzats"    :"esdeveniments",
    "ips_conferencies_convidades"                         :"esdeveniments",
    "ips_comites_internacionals_participats"              :"esdeveniments",
    "ips_articles_Q1"                                     :"scopus",
    "ips_articles_D1_percentatge"                         :"scopus",
    "ips_articles_FWCI_10"                                :"scopus",
    "ips_treball_editorial_Q1"                            :"esdeveniments",
    "ips_tesis_doctorals"                                 :"RRHH",
    "ips_postdocs_supervisats"                            :"RRHH",
    "ips_estades_recercaires_acollits"                    :"RRHH",
    "ips_euros_projectes_KTT"                             :"ecofin",
    "ips_formacions_per_empreses_organitzades"            :"esdeveniments",
    "ips_patents_i_secrets_industrials"                   :"ordi",
    "ips_spinoffs_i_startups"                             :"ordi",
    "ips_articles_amb_socis_industrials"                  :"scopus",
    "ips_estudiants_acollits"                             :"RRHH",
    "ips_cites_en_legislacio"                             :"scopus",
    "ips_participacions_comites_experts_ambit_legislatiu" :"esdeveniments",
    "ips_premis_nacionals_i_internacionals"               :"esdeveniments",
    "ips_narratives_impacte_CERCA"                        :"esdeveniments",
    "ips_actes_disseminacio_participats_o_organitzats"    :"esdeveniments",
    "ips_aparicions_mitjans_comunicacio_nacionals"        :"esdeveniments",
    "ips_aparicions_mitjans_comunicacio_internacionals"   :"esdeveniments",
  };

  /*utils*/
  //soluciona problema dels codis projecte que comencen per "0"
  function busca_projecte(codi, arr, nom_columna){
    arr         = arr         || app.taules.projectes.taula;
    nom_columna = nom_columna || "Código Identificativo";

    //cerca normal
    let p = arr.find(p=>p[nom_columna]==codi);
    if(p) return p;

    //posa 2 zeros davant del codi
    let codi2=`00${codi}`;
    p = arr.find(p=>p[nom_columna]==codi2);
    if(p) return p;
    p = arr.find(p=>("00"+p[nom_columna])==codi);
    if(p) return p;

    //posa 1 zero davant del codi
    let codi1=`0${codi}`;
    p = arr.find(p=>p[nom_columna]==codi1);
    if(p) return p;
    p = arr.find(p=>("0"+p[nom_columna])==codi);
    if(p) return p;

    return false;
  }

  /*DEFINICIÓ INDICADORS*/
  let ambits=[
    new Ambit("Patronat",[
      new Bloc("Excel·lència en recerca",30,[                       /* pes  |24, 25, 26, 27, 28, 29| basal */
        new Indicador(`euros_recerca`,                                   10, [0,  2,  4,  6,  8, 10],[ 2995]),
        new Indicador(`euros_recerca_horizon`,                            5, [0,  1,  2,  3,  4,  5],[ 1248]),
        new Indicador(`euros_recerca_erc_eic`,                            5, [0,  0,  5, 50, 50, 50],[   38]),
        new Indicador(`euros_recerca_estatal`,                            5, [0,  1,  2,  3,  4,  5],[ 1189]),
        new Indicador(`euros_recerca_regional` ,                          5, [0,  1,  2,  3,  4,  5],[  518]),
        new Indicador(`projectes_horizon`,                               10, [0,  1,  1,  2,  2,  2],[    1]),
        new Indicador(`projectes_erc_eic`,                             12.5, [0,  1,  2,  2,  2,  2],[    1]),
        new Indicador(`congressos_tallers_escoles_estiu_organitzats`,     5, [0,  5, 10, 10, 10, 15],[    3]),
        new Indicador(`sessions_especials_organitzades`,                  5, [0,  1,  2,  3,  4,  5],[    4]),
        new Indicador(`comites_internacionals_participats`,             2.5, [0,  5, 10, 10, 10, 15],[    3]),
        new Indicador(`articles_Q1`,                                      5, [0,  1,  2,  3,  4,  4],[  105]),
        new Indicador(`articles_Q1_amb_lideratge`,                        5, [0, 46, 48, 50, 52, 55],[   45]),
        new Indicador(`articles_D1`,                                      5, [0,  1,  2,  2,  3,  3],[   75]),
        new Indicador(`cites_articles`,                                  10, [0,  1,  2,  3,  4,  4],[14215]),
        new Indicador(`impact_factor`,                                    5, [0,  1,  2,  3,  4,  4],[11.75]),
        new Indicador(`estades_recercaires_acollits`,                   2.5, [0,  1,  2,  3,  4,  4],[    5]),
        new Indicador(`estades_recercaires_en_altres_centres`,          2.5, [0,  1,  2,  3,  4,  4],[    1]),
        new Indicador(`rati_exit_propostes_europa`,                       5, [0,  1,  2,  3,  4,  4],[   20]),
      ]),
      new Bloc("Promoure línies de recerca estratègiques",5,[
        new Indicador(`euros_recerca_L17_L18`,                           50, [0, 30, 30, 60, 60, 60],[0]),
        new Indicador(`articles_Q1_L17_L18`,                             50, [0,  0,  5,  5, 10, 10],[0]),
      ]),
      new Bloc("Promoure transferència",20,[
        new Indicador(`euros_projectes_KTT_respecte_total`,              10, [0, 13, 14, 16, 18, 18],[ 12]),
        new Indicador(`euros_projectes_KTT`,                             30, [0, 20, 30, 40, 50, 60],[395]),
        new Indicador(`projectes_KTT`,                                   15, [0,  5,  5, 10, 15, 20],[ 21]),
        new Indicador(`formacions_per_empreses_organitzades`,            15, [0,  5, 10, 20, 25, 50],[  3]),
        new Indicador(`projectes_llavor_producte_innovadors`,            15, [0,  1,  2,  2,  2,  2],[  0]),
        new Indicador(`doctorats_industrials`,                           15, [0,  1,  2,  2,  3,  3],[  0]),
      ]),
      new Bloc("Promoure mecenatge",5,[
        new Indicador(`euros_mecenatge`,                                 70, [0, 20, 30, 40, 50, 60],[0]),
        new Indicador(`projectes_mecenatge`,                             30, [0,  2,  3,  4,  4,  5],[0]),
      ]),
      new Bloc("Generació PI, spin-offs, start-ups",5,[
        new Indicador(`patents_i_secrets_industrials`,                   20, [0, 1, 1,  2,  2,  2],[ 3]),
        new Indicador(`spinoffs_i_startups`,                             40, [0, 1, 1,  1,  1,  2],[ 1]),
        new Indicador(`articles_amb_socis_industrials`,                  40, [0, 5, 5, 10, 10, 15],[13]),
      ]),
      new Bloc("Promoure impacte",20,[
        new Indicador(`estudiants_acollits`,                             10, [0, 10, 15, 20, 25, 30],[ 1]),
        new Indicador(`cites_en_legislacio`,                             15, [0, 10, 15, 20, 25, 30],[87]),
        new Indicador(`participacions_comites_experts_ambit_legislatiu`, 20, [0, 10, 15, 20, 25, 30],[ 3]),
        new Indicador(`premis_nacionals`,                                 5, [0, 10, 15, 20, 25, 30],[ 1]),
        new Indicador(`premis_internacionals`,                            5, [0, 10, 15, 20, 25, 30],[ 0]),
        new Indicador(`narratives_impacte_CERCA`,                        15, [0,  1,  1,  2,  2,  3],[ 0]),
        new Indicador(`contribucions_gestio_aigua`,                      10, [0,  0,  1,  1,  2,  2],[ 0]),
        new Indicador(`llocs_de_treball_generats_llicencies`,             5, [0,  0,  1,  2,  2,  3],[ 0]),
        new Indicador(`aliances_solides_entitats_socials`,               15, [0,  1,  2,  2,  3,  3],[ 1]),
      ]),
      new Bloc("Promoure comunicació",10,[
        new Indicador(`xxss_seguidors`,                                25, [0,  10,  15,  20,  25,  30],[1164]),
        new Indicador(`xxss_shares`,                                    5, [0,  10,  15,  20,  25,  30],[ 505]),
        new Indicador(`xxss_streams`,                                  10, [0, 100, 200, 300, 500, 800],[   0]),
        new Indicador(`actes_disseminacio_participats_o_organitzats`,  15, [0,   5,  10,  15,  20,  20],[   0]),
        new Indicador(`aparicions_mitjans_comunicacio_nacionals`,      25, [0,  10,  15,  20,  25,  30],[ 197]),
        new Indicador(`aparicions_mitjans_comunicacio_internacionals`, 20, [0,  10,  15,  20,  25,  30],[  11]),
      ]),
      new Bloc("Relació amb patrons",5,[
        //new Indicador(`reunions_taula_aigua_ACA`,                             5, [0,  9,  9,  9,  9,  9],   0),
        new Indicador(`hores_tasques_taula_aigua_ACA`,                         10, [0,300,400,500,550,600],[  0]),
        new Indicador(`euros_projectes_KTT_ACA`,                               25, [0, 10, 20, 30, 40, 45],[ 50]),
        new Indicador(`tallers_UdG_ICRA`,                                      15, [0,  1,  1,  2,  2,  2],[  0]),
        new Indicador(`iniciatives_UdG_ICRA`,                                  15, [0,  1,  1,  2,  2,  2],[  3]),
        new Indicador(`euros_projectes_KTT_UdG`,                               25, [0,  0,  5,  5, 10, 10],[305]),
        new Indicador(`participacions_activitats_JEDI_organitzades_per_CERCA`, 10, [0,  5, 10, 12, 15, 15],[  0]),
      ]),
    ]),
    new Ambit("Contracte Programa",[
      new Bloc("Excel·lència en recerca",30,[                       /* pes  |24, 25, 26, 27, 28, 29| basal */
        new Indicador(`euros_recerca`,                                   10, [0,  2,  4,  6,  8, 10],[2995]),
        new Indicador(`euros_recerca_horizon`,                            5, [0,  1,  2,  3,  4,  5],[1248]),
        new Indicador(`euros_recerca_erc_eic`,                            5, [0,  0,  5, 50, 50, 50],[  38]),
        new Indicador(`euros_recerca_estatal`,                            5, [0,  1,  2,  3,  4,  5],[1189]),
        new Indicador(`euros_recerca_regional` ,                          5, [0,  1,  2,  3,  4,  5],[ 518]),
        new Indicador(`projectes_horizon`,                               10, [0,  1,  1,  2,  2,  2],[   1]),
        new Indicador(`projectes_erc_eic`,                             12.5, [0,  1,  2,  2,  2,  2],[   1]),
        new Indicador(`congressos_tallers_escoles_estiu_organitzats`,     5, [0,  5, 10, 10, 10, 15],[   3]),
        new Indicador(`sessions_especials_organitzades`,                  5, [0,  1,  2,  3,  4,  5],[   4]),
        new Indicador(`comites_internacionals_participats`,             2.5, [0,  5, 10, 10, 10, 15],[   3]),

        new Indicador(`articles_Q1`,                                      5, [0,  1,  2,  3,  4,  4],[105]),
        new Indicador(`articles_Q1_amb_lideratge`,                        5, [0, 46, 48, 50, 52, 55],[ 45]),
        new Indicador(`articles_FWCI_10`,                                 5, [0,  1,  2,  2,  3,  3],[  1]),

        new Indicador(`cites_articles`,                                  10, [0,  1,  2,  3,  4,  4],[14215]),
        new Indicador(`impact_factor`,                                    5, [0,  1,  2,  3,  4,  4],[11.75]),
        new Indicador(`estades_recercaires_acollits`,                   2.5, [0,  1,  2,  3,  4,  4],[    5]),
        new Indicador(`estades_recercaires_en_altres_centres`,          2.5, [0,  1,  2,  3,  4,  4],[    1]),
        new Indicador(`rati_exit_propostes_europa`,                       5, [0,  1,  2,  3,  4,  4],[   20]),
      ]),
      new Bloc("Promoure línies de recerca estratègiques",5,[
        new Indicador(`euros_recerca_L17_L18`,                           50, [0, 30, 30, 60, 60, 60],[0]),
        new Indicador(`articles_Q1_L17_L18`,                             50, [0,  0,  5,  5, 10, 10],[0]),
      ]),
      new Bloc("Promoure transferència",20,[
        new Indicador(`euros_projectes_KTT_respecte_total`,              10, [0, 13, 14, 16, 18, 18],[ 12]),
        new Indicador(`euros_projectes_KTT`,                             30, [0, 20, 30, 40, 50, 60],[395]),
        new Indicador(`projectes_KTT`,                                   15, [0,  5,  5, 10, 15, 20],[ 21]),
        new Indicador(`formacions_per_empreses_organitzades`,            15, [0,  5, 10, 20, 25, 50],[  3]),
        new Indicador(`projectes_llavor_producte_innovadors`,            15, [0,  1,  2,  2,  2,  2],[  0]),
        new Indicador(`doctorats_industrials`,                           15, [0,  1,  2,  2,  3,  3],[  0]),
      ]),
      new Bloc("Promoure mecenatge",5,[
        new Indicador(`euros_mecenatge`,                                 70, [0, 20, 30, 40, 50, 60],[0]),
        new Indicador(`projectes_mecenatge`,                             30, [0,  2,  3,  4,  4,  5],[0]),
      ]),
      new Bloc("Generació PI, spin-offs, start-ups",5,[
        new Indicador(`patents_i_secrets_industrials`,                   20, [0, 1, 1,  2,  2,  2],[ 3]),
        new Indicador(`spinoffs_i_startups`,                             40, [0, 1, 1,  1,  1,  2],[ 1]),
        new Indicador(`articles_amb_socis_industrials`,                  40, [0, 5, 5, 10, 10, 15],[13]),
      ]),
      new Bloc("Promoure impacte",20,[
        new Indicador(`estudiants_acollits`,                             10, [0, 10, 15, 20, 25, 30],[ 1]),
        new Indicador(`cites_en_legislacio`,                             15, [0, 10, 15, 20, 25, 30],[87]),
        new Indicador(`participacions_comites_experts_ambit_legislatiu`, 20, [0, 10, 15, 20, 25, 30],[ 3]),
        new Indicador(`premis_nacionals`,                                 5, [0, 10, 15, 20, 25, 30],[ 1]),
        new Indicador(`premis_internacionals`,                            5, [0, 10, 15, 20, 25, 30],[ 0]),
        new Indicador(`narratives_impacte_CERCA`,                        15, [0,  1,  1,  2,  2,  3],[ 0]),
        new Indicador(`contribucions_gestio_aigua`,                      10, [0,  0,  1,  1,  2,  2],[ 0]),
        new Indicador(`llocs_de_treball_generats_llicencies`,             5, [0,  0,  1,  2,  2,  3],[ 0]),
        new Indicador(`aliances_solides_entitats_socials`,               15, [0,  1,  2,  2,  3,  3],[ 1]),
      ]),
      new Bloc("Promoure comunicació",10,[
        new Indicador(`xxss_seguidors`,                                25, [0,  10,  15,  20,  25,  30],[1164]),
        new Indicador(`xxss_shares`,                                    5, [0,  10,  15,  20,  25,  30],[ 505]),
        new Indicador(`xxss_streams`,                                  10, [0, 100, 200, 300, 500, 800],[   0]),
        new Indicador(`actes_disseminacio_participats_o_organitzats`,  15, [0,   5,  10,  15,  20,  20],[   0]),
        new Indicador(`aparicions_mitjans_comunicacio_nacionals`,      25, [0,  10,  15,  20,  25,  30],[ 197]),
        new Indicador(`aparicions_mitjans_comunicacio_internacionals`, 20, [0,  10,  15,  20,  25,  30],[  11]),
      ]),
      new Bloc("Relació amb patrons",5,[
        //new Indicador(`reunions_taula_aigua_ACA`,                             5, [0,  9,  9,  9,  9,  9], 0),
        new Indicador(`hores_tasques_taula_aigua_ACA`,                         10, [0,300,400,500,550,600],[  0]),
        new Indicador(`euros_projectes_KTT_ACA`,                               25, [0, 10, 20, 30, 40, 45],[ 50]),
        new Indicador(`tallers_UdG_ICRA`,                                      15, [0,  1,  1,  2,  2,  2],[  0]),
        new Indicador(`iniciatives_UdG_ICRA`,                                  15, [0,  1,  1,  2,  2,  2],[  3]),
        new Indicador(`euros_projectes_KTT_UdG`,                               25, [0,  0,  5,  5, 10, 10],[305]),
        new Indicador(`participacions_activitats_JEDI_organitzades_per_CERCA`, 10, [0,  5, 10, 12, 15, 15],[  0]),
      ]),
    ]),
    new Ambit("Pla d'Acció",[
      new Bloc("Pla d'Acció",0,[
        new Indicador(`eficiencia_articles_amb_socis_industrials`,         0,[30, 29, 27, 25] ,[  30]),
        new Indicador(`objectius_assolits_del_pla_formacio`,               0,[ 0, 20, 70, 80] ,[   0]),
        new Indicador(`participants_actes_disseminacio_participats`,       0,[ 0,100,250,500] ,[   0]),
        new Indicador(`projectes_competitius_outreach`,                    0,[ 0,  0,  1,  2] ,[   0]),
        new Indicador(`euros_projectes_competitius_outreach`,              0,[ 0,  0, 10, 20] ,[   0]),
        new Indicador(`aliances_solides_empreses_i_administracio_publica`, 0,[ 5,  5, 10, 15] ,[   5]),
        new Indicador(`projectes_i_encarrecs_ACA`,                         0,[ 5,  5,  7, 10] ,[   5]),
        new Indicador(`accions_suport_tecnic_a_ACA_quimica_analitica`,     0,[ 0,  1,  3,  5] ,[   0]),
        new Indicador(`participants_tallers_UdG_ICRA`,                     0,[ 0,120,180,240] ,[   0]),
        new Indicador(`nombre_IPs`,                                        0,[16, 16, 18, 20] ,[  16]),
        new Indicador(`posicions_RF_creades`,                              0,[ 0,  0,  2,  3] ,[   0]),
        new Indicador(`posicions_RS_estabilitzacio_RF`,                    0,[ 0,  0,  0,  1] ,[   0]),
        new Indicador(`canvis_tram_RS_o_RP`,                               0,[ 0,  0,  0,  8] ,[   0]),
        new Indicador(`sessions_JEDI_formacio_interna`,                    0,[ 0,  2,  4,  4] ,[   0]),
        new Indicador(`participants_sessions_JEDI_formacio_interna`,	     0,[ 5, 50, 80, 80] ,[   5]),
        new Indicador(`activitats_JEDI_organitzades`,	                     0,[ 0,  2,  5,  5] ,[   0]),
        new Indicador(`dones_categories_laborals_superiors`,               0,[37.5,37.5,40,42],[37.5]),
        new Indicador(`projectes_amb_administracio_central`,               0,[ 0,  2,  5,  5] ,[   0]),
        new Indicador(`euros_projectes_amb_administracio_central`,         0,[ 0,  5, 15, 30] ,[   0]),
      ]),
    ]),
    new Ambit("IPs",[
      new Bloc("Excel·lència en recerca",0,[
        new Indicador("ips_euros_recerca"                                   ),
        new Indicador("ips_projectes_erc_eic"                               ),
        new Indicador("ips_projectes_coordinats_5_socis_2M"                 ),
        new Indicador("ips_projectes_coordinats_4_socis_1M"                 ),
        new Indicador("ips_projectes_IP_o_COIP"                             ),
        new Indicador("ips_projectes_participant"                           ),
        new Indicador("ips_congressos_tallers_escoles_estiu_organitzats"    ),
        new Indicador("ips_conferencies_convidades"                         ),
        new Indicador("ips_comites_internacionals_participats"              ),
        new Indicador("ips_articles_Q1"                                     ),
        new Indicador("ips_articles_D1_percentatge"                         ),
        new Indicador("ips_articles_FWCI_10"                                ),
        new Indicador("ips_treball_editorial_Q1"                            ),
        new Indicador("ips_tesis_doctorals"                                 ),
        new Indicador("ips_postdocs_supervisats"                            ),
        new Indicador("ips_estades_recercaires_acollits"                    ),
      ]),
      new Bloc("Promoure transferència",0,[
        new Indicador("ips_euros_projectes_KTT"                             ),
        new Indicador("ips_formacions_per_empreses_organitzades"            ),
      ]),
      new Bloc("Generació PI, spin-offs, start-ups",0,[
        new Indicador("ips_patents_i_secrets_industrials"                   ),
        new Indicador("ips_spinoffs_i_startups"                             ),
        new Indicador("ips_articles_amb_socis_industrials"                  ),
      ]),
      new Bloc("Promoure impacte",0,[
        new Indicador("ips_estudiants_acollits"                             ),
        new Indicador("ips_cites_en_legislacio"                             ),
        new Indicador("ips_participacions_comites_experts_ambit_legislatiu" ),
        new Indicador("ips_premis_nacionals_i_internacionals"               ),
        new Indicador("ips_narratives_impacte_CERCA"                        ),
      ]),
      new Bloc("Promoure comunicació",0,[
        new Indicador("ips_actes_disseminacio_participats_o_organitzats"    ),
        new Indicador("ips_aparicions_mitjans_comunicacio_nacionals"        ),
        new Indicador("ips_aparicions_mitjans_comunicacio_internacionals"   ),
      ]),
    ]),
    new Ambit("UdG professors",[
      new Bloc("Excel·lència en recerca",0,[
        new Indicador("ips_euros_recerca"),
        new Indicador("ips_projectes_IP_o_COIP"),
        new Indicador("ips_projectes_participant"),
        new Indicador("ips_congressos_tallers_escoles_estiu_organitzats"    ),
        new Indicador("ips_conferencies_convidades"                         ),
        new Indicador("ips_comites_internacionals_participats"              ),
        new Indicador("ips_articles_Q1"                                     ),
        new Indicador("ips_articles_D1_percentatge"                         ),
        new Indicador("ips_articles_FWCI_10"                                ),
        new Indicador("ips_postdocs_supervisats"                            ),
        new Indicador("ips_estades_recercaires_acollits"                    ),
      ]),
      new Bloc("Promoure transferència",0,[
        new Indicador("ips_euros_projectes_KTT"                             ),
        new Indicador("ips_formacions_per_empreses_organitzades"            ),
      ]),
      new Bloc("Promoure impacte",0,[
        new Indicador("ips_estudiants_acollits"                             ),
        new Indicador("ips_cites_en_legislacio"                             ),
        new Indicador("ips_participacions_comites_experts_ambit_legislatiu" ),
      ]),
      new Bloc("Promoure comunicació",0,[
        new Indicador("ips_actes_disseminacio_participats_o_organitzats"    ),
        new Indicador("ips_aparicions_mitjans_comunicacio_nacionals"        ),
        new Indicador("ips_aparicions_mitjans_comunicacio_internacionals"   ),
      ]),
    ]),
  ];
</script>

<script>
  //configuracio columnes visibles i filtres per taules origen de dades
  class Conf_Taula{
    constructor(comentaris){
      this.taula    = null; //Array objectes | fetch_taula_undarius(nom_taula)
      this.columnes = {};   //objecte        | "nom_columna" => true/false
      this.filtres  = {};   //objecte        | "nom_columna" => valor (string o number) a filtrar

      this.comentaris = comentaris || "";

      this.error_loading = null; //TODO
    }

    get columnes_actives(){
      //retorna només noms columnes actives
      return Object.entries(this.columnes).filter(en=>en[1]).map(en=>en[0]);
    }
    get files_filtrades(){
      //retorna les files de la taula que compleixen tots els filtres
      if(!this.taula) return [];

      let filtres = Object.entries(this.filtres);
      if(filtres.length==0) return this.taula;

      return this.taula.filter(row=>{
        let bool = false;
        return filtres.every(([key,val])=>row[key]==val);
      });
    }
  }
</script>

<script>//vue app
  let app = Vue.createApp({
    data(){return{
      debug:1, //debug mode

      selected_years:{
        "2023":true,
        "2024":true,
        "2025":false,
        "2026":false,
        "2027":false,
        "2028":false,
        "2029":false,
      },

      ambits,                 //indicadors
      funcions_calculadores,  //taula helper funcions dels indicadors
      carregant:true,         //status
      ambit_actual:ambits[3], //objecte

      //veure detalls d'un sol indicador
      vista_detalls_indicador:false,
      html_detalls_indicador:false,

      //columna responsable indicador
      veure_responsable:true,
      filtre_responsable:false, //"RRHH","ordi",...

      //veure botó detalls
      veure_boto_detalls:true,

      //veure percentatge indicador
      veure_percentatge:true,

      //taules des d'on es calculen els indicadors: origens diversos (SQL icra, excels, ...)
      taules:{
        projectes:           new Conf_Taula("origen: 'projectes.xlsx'          (export fundanet per rdiaz)"),
        personal:            new Conf_Taula("origen: SQL Server ICRA           (icranet db per rdiaz)"),
        esdeveniments:       new Conf_Taula("origen: SQL Server ICRA           (icranet db per rdiaz)"),
        tipus_esdeveniments: new Conf_Taula("origen: SQL Server ICRA           (icranet db per rdiaz)"),
        ingressos:           new Conf_Taula("origen: SQL Server ICRA           (icranet db per rdiaz)"),
        taula_aigua:         new Conf_Taula("origen: SQL Server ICRA           (icranet db per rdiaz)"),
        projectes_personal:  new Conf_Taula("origen: 'projectes_personal.xlsx' (export fundanet per rdiaz)"),
        stakeholders:        new Conf_Taula("origen: 'stakeholders.xlsx'       (export fundanet per rdiaz)"),
        xarxes_socials:      new Conf_Taula("origen: 'xarxes_socials.xlsx'     (fet manualment per sdrammeh)"),
        scopus:              new Conf_Taula("origen: 'scopus.xlsx'             (fet manualment per etornes)"),
        sage:                new Conf_Taula("origen: 'sage_profiles.txt'       (fet manualment per lbosch, consultes fetes a temps real)"),
        projectes_icranet:   new Conf_Taula("origen: SQL Server ICRA           (icranet db per rdiaz)"),
        tesis:               new Conf_Taula("origen: SQL Server ICRA           (icranet db per rdiaz)"),
      },

      //opcions indicadors per IPs
      mode_visualitzacio_indicadors_ips:"ip_vs_indicadors",
      ip_seleccionat:null,
    }},

    methods:{
      calcular_tots_els_indicadors(){
        this.ambit_actual.blocs.forEach(bloc=>{
          bloc.indicadors.forEach(indi=>{
            indi.calcula();
          });
        });
      },

      //veure detalls indicador
      click_detalls_indicador(indi,year){
        this.vista_detalls_indicador=true;
        let html = this.crea_html_caption(indi,year);
        this.html_detalls_indicador=html;

        //scroll
        this.$nextTick().then(()=>{
          let el = document.querySelector("#detalls");
          if(el) el.scrollIntoView();
          PR.prettyPrint();
        });
      },

      //genera HTML per vista detalls indicador
      crea_html_caption(indi,year){
        let incr = indi.increment(year);
        let header=`
          <b>Detalls indicador [id:${indi.id}]</b>
          <p>
            <i>${indi.text}</i>
          </p>
          <p>Any: ${year}</p>
          <table border=1 small>
            <tr>
              <td>Valor (${year})</td>
              <td>${indi.years[year].valor} ${indi.unit}</td>
            </tr>
            <tr>
              <td>Valor basal (${indi.base_year})</td>
              <td>${indi.years[indi.base_year].valor} ${indi.unit}</td>
            </tr>
            <tr>
              <td>Canvi respecte valor basal</td>
              <td>${incr.delta} ${indi.unit} (${incr.perc.toFixed(0)}%)</td>
            </tr>
            <tr>
              <td>Objectiu ${year}</td>
              <td>+${incr.objectiu}%</td>
            </tr>
            <tr>
              <td>Compleix ${year}</td>
              <td>${incr.compleix?'Sí':'No'}</td>
            </tr>
          </table>
        `;
        let funcio="";
        let fx = funcions_calculadores[indi.funcio_calculadora];
        if(fx && app.debug){
          funcio+="<hr>";
          funcio+="<details>";
          funcio+="<summary small><b>[MODE DEBUG] Codi que calcula l'indicador</b></summary>";
          funcio+="<p>";
          funcio+=`<pre class="prettyprint lang-js"><code xsmall>`;
          fx.toString().split("\n").forEach(linia=>{
            funcio+=`${linia}\n`;
          });
          funcio+=`</code></pre>`;
          funcio+="</p>";
          funcio+="</details>";
        }

        let llista="";
        let arr = indi.years[year].llista;
        if(arr){
          llista+="<hr>";
          llista+=`Nombre d'elements: ${arr.length}`;
          llista+="<table border=1 xsmall>";
          arr.forEach((row,i)=>{
            if(i==0){
              llista+="<tr>";
              Object.entries(row).forEach(([key,_])=>{
                llista+=`<th>${key}</th>`;
              });
              llista+="</tr>";
            }
            llista+="<tr>";
            Object.entries(row).forEach(([_,val])=>{
              if(val && val.constructor===Object){
                val = JSON.stringify(val);
              }
              llista+=`<td>${val}</td>`;
            });
            llista+="</tr>";
          });
          llista+="</table>";
        }

        let ret=[
          header,
          funcio,
          llista,
        ].join("");

        return ret;
      },

      get_ips(year){
        if(!this.tot_carregat) return false;
        year = year || false;

        //només filtra per any si s'especifica a la crida de la funció
        let personal = this.taules.projectes_personal.taula.filter(row=>{
          return(
            (
              row["EnQualitatde"]=="INVESTIGADOR/A PRINCIPAL (IP)"||
              row["EnQualitatde"]=="COORDINADOR/A PROJECTE"
            )&&
            row["VinculacioProjecte"]=="PERSONAL INVESTIGADOR"&&
            (
              row["Situación del Proyecto"]=="En Execucio"||
              row["Situación del Proyecto"]=="Finalitzat"||
              row["Situación del Proyecto"]=="Tancat"
            )&&
            (
              row["Tipo de Financiación Contracte Programa"]=="RECERCA"||
              row["Tipo de Financiación Contracte Programa"]=="TRANSFERENCIA"
            )&&
            (year ? new Date(row["DataInici"]).getFullYear()<=year : true) &&
            (year ? new Date(row["DataFi"   ]).getFullYear()>=year : true)
          );
        });

        //{nom,orcid}
        let ips=[];
        let noms = Array.from(new Set(personal.map(row=>row.Persona)));

        noms.forEach(nom=>{
          let tr     = this.treu_accents; //function
          let tr_nom = tr(nom);
          let obj = this.taules.personal.taula.find(row=>tr(row.Nom)==tr_nom);
          if(!obj) return;
          let orcid  = obj.ORCID;
          let email  = obj.Email;
          let genere = obj.Descripcio;
          ips.push({nom,orcid,email});
        });

        if(noms.length != ips.length){
          console.warn("noms.length != ips.length");
          console.log({noms,ips});
        }

        //ordena alfabèticament
        ips.sort((a,b)=>a.nom>b.nom?1:-1);

        return ips;
      },

      get_professors(year){
        if(!this.tot_carregat) return false;
        year = year || false;

        let personal = this.taules.personal.taula.filter(row=>{
          return(
            row["Categoria"]=="015. RESEARCH PROFESSOR ASSOCIATED"&&
            row["Nacionalitat"]=="ESPANYA"&&
            (year ? new Date(row["Datainicicontracte"]).getFullYear()<=year : true) &&
            (year ? new Date(row["DataFiContracte"   ]).getFullYear()>=year : true)
          );
        });

        //{nom,orcid,email}
        let professors=[];
        //let tr = this.treu_accents; //function
        personal.forEach(row=>{
          let nom    = this.treu_accents_lite(row.Nom);
          let orcid  = row.ORCID;
          let email  = row.Email;
          let genere = row.Descripcio;
          professors.push({nom,orcid,email});
        });

        //ordena alfabèticament
        professors.sort((a,b)=>a.nom>b.nom?1:-1);

        return professors;
      },

      treu_accents(Str){
        if(!Str) return false;

        let str = Str.toLowerCase();
        str = str.replace(new RegExp("\\s",      'g'),""); // "\s" matches spaces
        str = str.replace(new RegExp("[àáâãäå]", 'g'),"a");
        str = str.replace(new RegExp("æ",        'g'),"ae");
        str = str.replace(new RegExp("ç",        'g'),"c");
        str = str.replace(new RegExp("[èéêë]",   'g'),"e");
        str = str.replace(new RegExp("[ìíîï]",   'g'),"i");
        str = str.replace(new RegExp("ñ",        'g'),"n");
        str = str.replace(new RegExp("[òóôõö]",  'g'),"o");
        str = str.replace(new RegExp("œ",        'g'),"oe");
        str = str.replace(new RegExp("[ùúûü]",   'g'),"u");
        str = str.replace(new RegExp("[ýÿ]",     'g'),"y");
        str = str.replace(new RegExp("\\W",      'g'),"");
        return str;
      },

      treu_accents_lite(str){
        if(!str) return false;

        str = str.replace(new RegExp("[àáâãäå]", 'g'),"a");
        str = str.replace(new RegExp("[ÀÁÂÃÄÅ]", 'g'),"A");

        str = str.replace(new RegExp("æ",        'g'),"ae");
        str = str.replace(new RegExp("Æ",        'g'),"AE");

        str = str.replace(new RegExp("ç",        'g'),"c");
        str = str.replace(new RegExp("Ç",        'g'),"C");

        str = str.replace(new RegExp("[èéêë]",   'g'),"e");
        str = str.replace(new RegExp("[ÈÉÊË]",   'g'),"E");

        str = str.replace(new RegExp("[ìíîï]",   'g'),"i");
        str = str.replace(new RegExp("[ÌÍÎÏ]",   'g'),"I");

        str = str.replace(new RegExp("ñ",        'g'),"n");
        str = str.replace(new RegExp("Ñ",        'g'),"N");

        str = str.replace(new RegExp("[òóôõö]",  'g'),"o");
        str = str.replace(new RegExp("[ÒÓÔÕÖ]",  'g'),"O");

        str = str.replace(new RegExp("œ",        'g'),"oe");
        str = str.replace(new RegExp("Œ",        'g'),"OE");

        str = str.replace(new RegExp("[ùúûü]",   'g'),"u");
        str = str.replace(new RegExp("[ÙÚÛÜ]",   'g'),"U");

        str = str.replace(new RegExp("[ýÿ]",     'g'),"y");
        str = str.replace(new RegExp("[ÝŸ]",     'g'),"Y");

        /* "\W": Non-word character class escape: Matches any character that is
           not a word character from the basic Latin alphabet. Equivalent to
           [^A-Za-z0-9_]. For example, /\W/ or /[^A-Za-z0-9_]/ matches "%" in
           "50%" and "É" in "Émanuel".
        */
        str = str.replace(new RegExp("[^\\w\\s,]",      'g'),"");
        return str;
      },
    },

    computed:{
      years(){
        return Object.entries(this.selected_years).filter(en=>en[1]).map(en=>en[0]);
      },

      //retorna valors únics del camp responsable per poder crear un filtre
      get_responsables(){
        return Array.from(new Set(Object.values(responsables)));
      },

      //boolea per saber si totes les taules auxiliars tenen valors
      tot_carregat(){
        return (
          Object.values(this.taules).every(obj=>obj.taula)
        );
      },

      taula_resum_esdeveniments(){
        if(!this.tot_carregat) return false;
        let taula=[];//retval
        let ips = this.get_ips();

        let tr = this.treu_accents; //function

        ips.forEach(ip=>{
          let nom           = tr(ip.nom);
          let esdeveniments = this.taules.esdeveniments.taula.filter(row=>tr(row.Persona)==nom);
          esdeveniments.sort((a,b)=>{
            return a.DataInici_Esdeveniment<b.DataInici_Esdeveniment?1:-1;
          });
          let new_row = {
            ip,
            esdeveniments,
          };
          taula.push(new_row);
        });

        taula.sort((a,b)=>{
          return b.esdeveniments.length-a.esdeveniments.length;
        })

        return taula;
      },
    },
  }).mount("#app");

  //columnes activades per defecte
  app.taules.projectes.columnes={
    "Situación del Proyecto":true,
    "Título Abreviado":true,
    "Naturaleza del Proyecto":true,
    "Concurrencia":true,
  };
  app.taules.personal.columnes={
    "Nom":true,
    "Contracte":true,
  };
  app.taules.esdeveniments.columnes={
    "Esdeveniment":true,
    "Persona":true,
  };
  app.taules.tipus_esdeveniments.columnes={
    "Descripcio":true,
    "Observacions":true,
  };
  app.taules.ingressos.columnes={
    "Any":true,
    "Codi":true,
    "Ingressos":true,
  };
  app.taules.taula_aigua.columnes={
    "Codi":true,
    "Nom":true,
    "DataAlta":true,
    "Horas":true,
    "Descripcio":true,
  };
  app.taules.projectes_personal.columnes={
    "Persona":true,
    "EnQualitatde":true,
    "Projecte":true,
  };
  app.taules.stakeholders.columnes={
    "Proyecto":true,
    "Tercero":true,
    "Tipo Aportación":true,
  };
  app.taules.scopus.columnes={
    "year":true,
    "articles_Q1":true,
    "cites_articles":true,
    "cites_en_legislacio":true,
  };
  app.taules.xarxes_socials.columnes={
    "any":true,
    "seguidors":true,
    "shares":true,
    "streams":true,
  };
  app.taules.sage.columnes={
    "nom":true,
    "cites":true,
    "response_rebuda":true,
  };
</script>

<script>
  //consulta SQL SERVER via node express instalat al cluster que consulta el server "srv-apps-03.icra.local"
  //pq funcioni cal estar connectat a la VPN icra
  async function fetch_taula_undarius(nom_taula_sql, nom_taula_desti){
    //nom_taula_sql: String
    //nom_taula_desti: String

    nom_taula_desti = nom_taula_desti || nom_taula_sql;

    try{
      //console.log(`llegint SQL server /${nom_taula}...`);
      let url=`https://undarius.icra.local:50000/${nom_taula_sql}`;
      let response = await fetch(url);
      if(!response.ok){
        throw(`error fetching SQL Server (taula '${nom_taula_sql}')`);
      }

      let data = await response.json();
      app.taules[nom_taula_desti].taula = data;
      console.log(`OK GET /${nom_taula_sql} (MSSQL)`);
    }catch(err){
      console.error('Error fetching data:', err);
      app.carregant = false;
    }
  }
  fetch_taula_undarius("projectes","projectes_icranet");
  fetch_taula_undarius("personal");
  fetch_taula_undarius("esdeveniments");
  fetch_taula_undarius("tipus_esdeveniments");
  fetch_taula_undarius("ingressos");
  fetch_taula_undarius("taula_aigua");
  fetch_taula_undarius("tesis");
</script>

<script>
  //read excel file from local url
  async function llegir_excel(nom_taula, url){
    //url = "csv/export-fundanet/fitxer.xlsx"
    let res    = await fetch(url);
    let blob   = await res.blob();
    let reader = new FileReader();
    let wb     = new ExcelJS.Workbook();

    reader.readAsArrayBuffer(blob);
    reader.onload=async function(){
      let buffer = reader.result;
      await wb.xlsx.load(buffer);
      let taula = converteix_wb_a_taula_json(wb);
      app.taules[nom_taula].taula = taula;
      console.log(`OK excel "${nom_taula}.xlsx" (fetch)`)
      /*
        wb.worksheets (array)
        sheet.columns (array)
        column.values (array)
        value._number
      */
    };
  }
  //helper function for "llegir_excel"
  function converteix_wb_a_taula_json(wb, index_sheet){
    index_sheet = index_sheet || 0;

    let taula=[];//retval

    //noms columnes: valors primera fila
    let noms_columnes = wb.worksheets[index_sheet]._rows[0].values;

    //omple la taula
    wb.worksheets[index_sheet]._rows.forEach((row,i)=>{
      if(i==0) return; //skip primera fila
      let new_row={};
      noms_columnes.forEach((key,j)=>{
        let val = row.values[j];
        new_row[key]=val;
      });
      taula.push(new_row);
    });
    return taula;
  }

  llegir_excel("projectes",          "csv/export-fundanet/Projectes.xlsx");
  llegir_excel("projectes_personal", "csv/export-fundanet/Projectes_Personal2.xlsx");
  llegir_excel("stakeholders",       "csv/export-fundanet/Stakeholders3.xlsx");
  llegir_excel("xarxes_socials",     "csv/export-fundanet/xarxes_socials.xlsx");
  llegir_excel("scopus",             "csv/export-fundanet/scopus.xlsx");
</script>

<script>
  fetch("sage_profiles.txt").then(r=>r.text()).then(txt=>{
    let taula=[];
    let linies = txt.split("\n").filter(e=>e);

    linies.forEach(linia=>{
      let tokens = linia.split("/");
      let id_user = tokens[4];
      let nom     = tokens[5];
      let newrow={
        nom,
        id_user,
        cites:{},
        response_rebuda:false,
      };
      taula.push(newrow);
    });

    app.taules.sage.taula=taula;
    console.log(`OK "sage_profiles.txt" (fetch)`);

    taula.forEach(async row=>{
      let cites = await fetch_sage_user(row.id_user); //async
      row.cites = cites;
      row.response_rebuda = true;

      let N = app.taules.sage.taula.length;
      let n = app.taules.sage.taula.filter(row=>row.response_rebuda).length;
      console.log(`OK sage id:${row.id_user} (${n}/${N})`);
    });
  });

  async function fetch_sage_user(id_user){
    //id_user: string;

    let url=`curl_sagepub_user.php?id_user=${id_user}`;
    let res = await fetch(url);
    if(!res.ok) throw(`error fetching sage profile (${id_user})`);
    let data = await res.json();

    let cites={};
    //itera dois investigador
    Object.entries(data.data.citations).forEach(([doi,list])=>{
      //itera policy documents
      list.forEach(doc=>{
        let id       = doc.policy_document_id; //string
        let pub_year = data.data.documents[id].published_on.split("-")[0]; //string
        if(cites[pub_year]==undefined) cites[pub_year]=0;
        cites[pub_year]++;
      });
    });

    return cites;
  }
</script>
